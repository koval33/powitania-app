<%- include('partials/head') %>

<section class="py-10 md:py-16">
  <div class="max-w-5xl mx-auto px-4">

    <!-- Breadcrumb -->
    <nav class="text-sm mb-8">
      <a href="/" class="text-gray-500 hover:text-white transition-colors">Strona główna</a>
      <span class="text-gray-600 mx-2">/</span>
      <a href="/bank-glosow/" class="text-gray-500 hover:text-white transition-colors">Bank głosów</a>
      <span class="text-gray-600 mx-2">/</span>
      <span class="text-gray-300"><%= lektor.name %></span>
    </nav>

    <!-- Profil: zdjęcie + info -->
    <div class="flex flex-col md:flex-row gap-8 md:gap-12">

      <!-- Lewa kolumna: zdjęcie + tagi -->
      <div class="flex-shrink-0">
        <div class="w-48 h-48 md:w-56 md:h-56 rounded-2xl overflow-hidden border-2 border-white/10 mx-auto md:mx-0">
          <img src="<%= lektor.photo %>" alt="<%= lektor.name %>" class="w-full h-full object-cover">
        </div>
        <div class="flex flex-wrap gap-2 mt-4 justify-center md:justify-start">
          <% if (lektor.famous) { %>
            <span class="bg-yellow-500/10 text-yellow-400 text-xs font-semibold px-3 py-1 rounded-full border border-yellow-500/20">Znani i lubiani</span>
          <% } %>
          <% if (lektor.native) { %>
            <span class="bg-blue-500/10 text-blue-400 text-xs font-semibold px-3 py-1 rounded-full border border-blue-500/20">Native speaker</span>
          <% } %>
          <span class="bg-dark-700 text-gray-400 text-xs font-medium px-3 py-1 rounded-full border border-white/10">
            <%= lektor.gender === 'm' ? 'Mężczyzna' : 'Kobieta' %>
          </span>
          <span class="bg-dark-700 text-gray-400 text-xs font-medium px-3 py-1 rounded-full border border-white/10">
            <%= lektor.age %>
          </span>
        </div>
      </div>

      <!-- Prawa kolumna: dane -->
      <div class="flex-1 min-w-0">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-3"><%= lektor.name %></h1>

        <% if (lektor.description) { %>
          <p class="text-gray-400 leading-relaxed mb-4"><%= lektor.description %></p>
        <% } %>

        <!-- Meta info — kompaktowo -->
        <div class="flex flex-wrap items-center gap-x-4 gap-y-1.5 text-sm text-gray-400 mb-4">
          <span><%= lektor.languages.join(', ') %></span>
          <span class="text-gray-600">·</span>
          <span>Realizacja: <span class="text-white"><%= lektor.turnaround || '24-48h' %></span></span>
          <% if (lektor.applications && lektor.applications.length > 0) { %>
          <span class="text-gray-600">·</span>
          <% lektor.applications.forEach(function(app) { %>
            <span class="text-xs bg-accent/10 text-accent px-2 py-0.5 rounded-full"><%= app %></span>
          <% }); %>
          <% } %>
        </div>

        <!-- PRÓBKI GŁOSOWE — od razu w kolumnie -->
        <%
          var allAudio = [];
          var seenUrls = {};
          var samples = lektor.samples || [];
          if (lektor.audio) {
            allAudio.push({ name: (samples[0] && samples[0].name) || 'Próbka główna', url: lektor.audio });
            seenUrls[lektor.audio] = true;
            if (samples.length > 0 && samples[0].url) seenUrls[samples[0].url] = true;
          }
          samples.forEach(function(s) {
            if (!s.url) return;
            var isVideo = s.url.includes('youtu') || s.url.includes('vimeo');
            if (!isVideo && !seenUrls[s.url]) {
              allAudio.push(s);
              seenUrls[s.url] = true;
            }
          });
          var videoSamples = (lektor.samples || []).filter(function(s) {
            return s.url && (s.url.includes('youtu') || s.url.includes('vimeo'));
          });
        %>

        <% if (allAudio.length > 0) { %>
        <div class="space-y-2 mb-5">
          <% allAudio.forEach(function(sample, idx) { %>
          <div class="sample-row bg-dark-800/60 rounded-lg border border-white/5 overflow-hidden">
            <div class="flex items-center gap-3 p-3">
              <button class="sample-play-btn w-10 h-10 flex-shrink-0 bg-accent hover:bg-accent-light rounded-full flex items-center justify-center transition-colors" data-audio="<%= sample.url %>">
                <svg class="play-icon w-4 h-4 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg class="pause-icon w-4 h-4 text-white hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
              </button>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-white font-medium truncate mb-1"><%= sample.name || ('Próbka ' + (idx + 1)) %></div>
                <div class="audio-progress w-full h-1.5 bg-dark-600 rounded-full overflow-hidden cursor-pointer">
                  <div class="audio-bar h-full bg-accent rounded-full transition-all" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-0.5">
                  <span class="audio-time text-xs text-gray-500">0:00</span>
                  <span class="audio-duration text-xs text-gray-500">--:--</span>
                </div>
              </div>
              <a href="<%= sample.url %>" download title="Pobierz MP3" class="w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full text-gray-500 hover:text-white hover:bg-dark-600 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
              </a>
            </div>
          </div>
          <% }); %>
        </div>
        <% } %>

        <!-- CTA -->
        <div class="flex flex-col sm:flex-row gap-3">
          <% if (!lektor.hidePrice) { %>
          <button onclick="showTextInputModal()" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors inline-flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V13.5zm0 2.25h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V18zm2.498-6.75h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V13.5zm0 2.25h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V18zm2.504-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zm0 2.25h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V18zm2.498-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zM8.25 6h7.5v2.25h-7.5V6zM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0012 2.25z"/></svg>
            Oblicz koszt
          </button>
          <button onclick="showInquiryModal()" class="border border-white/20 hover:border-white text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors">
            Zapytaj o wycenę
          </button>
          <% } else { %>
          <a href="#zapytanie" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors inline-flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/></svg>
            Zapytaj o wycenę
          </a>
          <% } %>
        </div>

        <!-- KALKULATOR CENOWY (widoczny gdy kontekst z kreatora) -->
        <div id="kreator-pricing-section" class="mt-6 hidden">
          <div class="bg-dark-800 rounded-2xl border-2 border-accent/30 p-6">
            <div class="flex items-center gap-3 mb-4">
              <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
              <h3 class="text-lg font-bold text-white">Twój tekst</h3>
            </div>
            <div class="bg-dark-900/50 rounded-lg p-3 mb-4">
              <div class="text-xs text-gray-500 mb-1">Wygenerowany tekst:</div>
              <div id="lektor-context-text" class="text-gray-300 text-sm leading-relaxed max-h-28 overflow-y-auto"></div>
            </div>
            <div id="pricing-calculator"></div>
            <div class="flex gap-3 mt-5">
              <button onclick="orderWithContext()" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold flex-1 transition-colors">
                Zamów nagranie
              </button>
              <button onclick="inquiryWithContext()" class="border border-white/20 hover:border-white text-white px-6 py-3 rounded-lg font-semibold flex-1 transition-colors">
                Zapytaj o szczegóły
              </button>
            </div>
            <button onclick="clearPricingContext()" class="text-sm text-gray-500 hover:text-accent mt-3 block mx-auto transition-colors">
              Wyczyść tekst
            </button>
          </div>
        </div>

      </div>
    </div>

    <!-- VIDEO (pełna szerokość, pod profilem) -->
    <%
      var videoSamples = (lektor.samples || []).filter(function(s) {
        return s.url && (s.url.includes('youtu') || s.url.includes('vimeo'));
      });
    %>

    <% if (videoSamples.length > 0) { %>
    <div class="mt-10">
      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/><path fill="#fff" d="M9.545 15.568V8.432L15.818 12z"/></svg>
        Realizacje wideo
      </h3>
      <div class="grid sm:grid-cols-2 gap-4">
        <% videoSamples.forEach(function(video) {
          var ytId = '';
          var url = video.url || '';
          if (url.includes('youtu.be/')) {
            ytId = url.split('youtu.be/')[1].split(/[?&#]/)[0];
          } else if (url.includes('youtube.com/watch')) {
            var match = url.match(/[?&]v=([^&#]+)/);
            if (match) ytId = match[1];
          } else if (url.includes('youtube.com/shorts/')) {
            ytId = url.split('shorts/')[1].split(/[?&#]/)[0];
          }
        %>
        <div class="bg-dark-800 rounded-xl border border-white/5 overflow-hidden group">
          <% if (ytId) { %>
          <div class="aspect-video relative cursor-pointer" onclick="loadYT(this, '<%= ytId %>')">
            <img src="https://img.youtube.com/vi/<%= ytId %>/mqdefault.jpg" alt="<%= video.name %>" class="w-full h-full object-cover" loading="lazy">
            <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors flex items-center justify-center">
              <div class="w-14 h-14 bg-red-600 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                <svg class="w-6 h-6 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </div>
            </div>
          </div>
          <% } else { %>
          <div class="aspect-video bg-dark-700 flex items-center justify-center">
            <a href="<%= video.url %>" target="_blank" rel="noopener" class="text-accent hover:text-accent-light">
              <svg class="w-12 h-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/></svg>
            </a>
          </div>
          <% } %>
          <div class="p-3">
            <div class="text-sm text-white font-medium"><%= video.name %></div>
          </div>
        </div>
        <% }); %>
      </div>
    </div>
    <% } %>

    <!-- FORMULARZ ZAPYTANIA (dla lektorów z hidePrice) -->
    <% if (lektor.hidePrice) { %>
    <div class="mt-12" id="zapytanie">
      <div class="max-w-2xl mx-auto bg-dark-800 rounded-2xl border border-white/5 p-8">
        <p class="text-gray-300 leading-relaxed mb-8">
          Udział artysty w projekcie jest potwierdzany indywidualnie. Proszę o przesłanie możliwie jak najszerszej informacji na temat projektu (typ nagrania, pole jego eksploatacji, czas na jaki ma zostać udzielona licencja) a my wrócimy z informacją na temat zainteresowania artysty i kosztów.
        </p>
        <hr class="border-white/10 mb-8">

        <form id="inquiry-form" enctype="multipart/form-data">
          <input type="hidden" name="lektorName" value="<%= lektor.name %>">
          <input type="hidden" name="lektorId" value="<%= lektor.id %>">

          <div class="mb-6">
            <label class="block text-white font-semibold mb-2">Opis projektu</label>
            <textarea name="description" rows="5" required
              class="w-full bg-dark-700 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none resize-y transition-colors"
              placeholder="Informacje o projekcie: typ nagrania, pole jego eksploatacji, czas na jaki ma zostać udzielona licencja..."></textarea>
          </div>

          <div class="grid sm:grid-cols-2 gap-6 mb-6">
            <div>
              <label class="block text-white font-semibold mb-2">Email:</label>
              <input type="email" name="email" required
                class="w-full bg-dark-700 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none transition-colors"
                placeholder="twoj@email.pl">
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Załącznik do formularza:</label>
              <label class="flex items-center gap-3 cursor-pointer bg-dark-700 border border-white/10 rounded-xl px-4 py-3 hover:border-white/20 transition-colors">
                <span class="bg-dark-600 text-gray-300 text-sm px-3 py-1 rounded-lg border border-white/10">Wybierz plik</span>
                <span class="text-gray-500 text-sm truncate file-label">Brak zaznaczonych plików</span>
                <input type="file" name="attachment" class="hidden" accept=".pdf,.doc,.docx,.txt,.rtf,.odt,.mp3,.wav,.zip" onchange="updateFileLabel(this)">
              </label>
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit" id="inquiry-submit"
              class="bg-accent hover:bg-accent-light text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider transition-colors">
              Wyślij zapytanie
            </button>
          </div>

          <div id="inquiry-msg" class="mt-4 text-center hidden"></div>
        </form>
      </div>
    </div>
    <% } %>

    <!-- CENNIK (jeśli nie ukryty) -->
    <% if (!lektor.hidePrice && lektor.prices) { %>
    <div class="mt-12">
      <h2 class="text-2xl font-bold text-white mb-6">Cennik</h2>

      <div class="grid md:grid-cols-3 gap-6">

        <!-- Powitanie / IVR -->
        <% if (lektor.prices.ivr_100) { %>
        <div class="bg-dark-800 rounded-xl border border-white/5 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 bg-emerald-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"/></svg>
            </div>
            <h3 class="text-white font-bold">Powitanie / IVR</h3>
          </div>
          <table class="w-full text-sm">
            <tbody class="divide-y divide-white/5">
              <tr>
                <td class="py-2 text-gray-400">do 100 słów</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.ivr_100 %> zł</td>
              </tr>
              <% if (lektor.prices.ivr_200) { %>
              <tr>
                <td class="py-2 text-gray-400">101-200 słów</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.ivr_200 %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_200plus && lektor.prices.ivr_200plus !== 'wycena') { %>
              <tr>
                <td class="py-2 text-gray-400">pow. 200 słów</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.ivr_200plus %> zł</td>
              </tr>
              <% } else { %>
              <tr>
                <td class="py-2 text-gray-400">pow. 200 słów</td>
                <td class="py-2 text-right text-accent text-xs font-medium">wycena indyw.</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_guarantee_100) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Gwarancja modyfikacji do 100 słów</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_guarantee_100 %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_guarantee_100plus) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Gwarancja modyfikacji pow. 100 słów</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_guarantee_100plus %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_melody) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Melodia w tle</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_melody %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_bilingual) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Pakiet dwujęzyczny</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_bilingual %> zł</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <% } %>

        <!-- Spot reklamowy -->
        <% if (lektor.prices.spot_radio_local) { %>
        <div class="bg-dark-800 rounded-xl border border-white/5 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 bg-red-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z"/></svg>
            </div>
            <h3 class="text-white font-bold">Spot reklamowy</h3>
          </div>
          <table class="w-full text-sm">
            <tbody class="divide-y divide-white/5">
              <tr>
                <td class="py-2 text-gray-400">Radio — lokalny</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_radio_local %> zł</td>
              </tr>
              <% if (lektor.prices.spot_radio_national) { %>
              <tr>
                <td class="py-2 text-gray-400">Radio — ogólnokrajowy</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_radio_national %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_tv_local) { %>
              <tr>
                <td class="py-2 text-gray-400">TV — lokalny</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_tv_local %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_tv_national) { %>
              <tr>
                <td class="py-2 text-gray-400">TV — ogólnokrajowy</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_tv_national %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_social_1min) { %>
              <tr>
                <td class="py-2 text-gray-400">Social media — do 1 min</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_social_1min %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_social_2min) { %>
              <tr>
                <td class="py-2 text-gray-400">Social media — do 2 min</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_social_2min %> zł</td>
              </tr>
              <% } %>
            </tbody>
          </table>
          <p class="text-xs text-gray-600 mt-3">Stawka uwzględnia licencję na okres do 12 mies.</p>
        </div>
        <% } %>

        <!-- Narracja do filmu -->
        <% if (lektor.prices.narration_1page) { %>
        <div class="bg-dark-800 rounded-xl border border-white/5 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/></svg>
            </div>
            <h3 class="text-white font-bold">Narracja do filmu</h3>
          </div>
          <table class="w-full text-sm">
            <tbody class="divide-y divide-white/5">
              <tr>
                <td class="py-2 text-gray-400">1 strona A4</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.narration_1page %> zł</td>
              </tr>
              <% if (lektor.prices.narration_2pages) { %>
              <tr>
                <td class="py-2 text-gray-400">2 strony A4</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.narration_2pages %> zł</td>
              </tr>
              <% } %>
              <% if (lektor.prices.narration_3pages) { %>
              <tr>
                <td class="py-2 text-gray-400">3 strony A4</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.narration_3pages %> zł</td>
              </tr>
              <% } %>
              <tr>
                <td class="py-2 text-gray-400">pow. 3 stron A4</td>
                <td class="py-2 text-right text-accent text-xs font-medium">wycena indyw.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <% } %>

      </div>
    </div>
    <% } %>

    <!-- Inni lektorzy -->
    <% if (similar && similar.length > 0) { %>
    <div class="mt-16">
      <h2 class="text-2xl font-bold text-white mb-6">Podobni lektorzy</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-5">
        <% similar.forEach(function(s) { %>
        <a href="/lektor/<%= s.id %>/" class="text-center group">
          <img src="<%= s.photo %>" alt="<%= s.name %>" class="w-20 h-20 rounded-full mx-auto object-cover border-2 border-white/10 group-hover:border-accent/50 transition-all mb-2" loading="lazy">
          <div class="text-white text-sm font-medium group-hover:text-accent transition-colors truncate"><%= s.name %></div>
          <div class="text-xs text-gray-600"><%= s.gender === 'm' ? 'Lektor' : 'Lektorka' %></div>
        </a>
        <% }); %>
      </div>
    </div>
    <% } %>

  </div>
</section>

<% if (!lektor.hidePrice) { %>
<!-- MODAL: Oblicz koszt -->
<div id="text-input-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-dark-800 rounded-2xl border border-white/10 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-dark-800 border-b border-white/10 p-6 flex items-center justify-between rounded-t-2xl">
      <h3 class="text-2xl font-bold text-white">Oblicz koszt nagrania</h3>
      <button onclick="closeTextModal()" class="text-gray-400 hover:text-white transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6">
      <p class="text-gray-400 mb-6">Wybierz, czy chcesz wkleić gotowy tekst, czy wygenerować nowy w kreatorze.</p>

      <!-- Opcja 1: Mam tekst -->
      <div class="bg-dark-700 rounded-xl border border-white/10 p-6 mb-4">
        <h4 class="text-white font-bold mb-3 flex items-center gap-2">
          <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          Mam gotowy tekst
        </h4>
        <textarea id="modal-text-input" rows="6" placeholder="Wklej tutaj swój tekst..." class="w-full bg-dark-900 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none resize-y mb-3"></textarea>
        <button onclick="calculateFromText()" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold w-full transition-colors">
          Oblicz wycenę
        </button>
      </div>

      <!-- Opcja 2: Nie mam tekstu -->
      <div class="bg-dark-700 rounded-xl border border-white/10 p-6">
        <h4 class="text-white font-bold mb-3 flex items-center gap-2">
          <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
          Nie mam tekstu — wygeneruj w kreatorze
        </h4>
        <p class="text-sm text-gray-400 mb-4">Kreator pomoże Ci stworzyć profesjonalny tekst dopasowany do Twojej branży.</p>
        <button onclick="goToKreatorWithLektor()" class="border-2 border-accent/50 hover:bg-accent/10 text-accent px-6 py-3 rounded-lg font-semibold w-full transition-colors">
          Przejdź do kreatora
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Zapytaj o wycenę -->
<div id="inquiry-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-dark-800 rounded-2xl border border-white/10 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-dark-800 border-b border-white/10 p-6 flex items-center justify-between rounded-t-2xl">
      <h3 class="text-2xl font-bold text-white">Zapytaj o wycenę</h3>
      <button onclick="closeInquiryModal()" class="text-gray-400 hover:text-white transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form id="inquiry-modal-form" class="p-6 space-y-4">
      <div>
        <label class="block text-white font-semibold mb-2 text-sm">Imię i nazwisko</label>
        <input type="text" name="name" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none" placeholder="Jan Kowalski">
      </div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-white font-semibold mb-2 text-sm">Email *</label>
          <input type="email" name="email" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none" placeholder="jan@firma.pl">
        </div>
        <div>
          <label class="block text-white font-semibold mb-2 text-sm">Telefon</label>
          <input type="tel" name="phone" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none" placeholder="+48 600 000 000">
        </div>
      </div>
      <div>
        <label class="block text-white font-semibold mb-2 text-sm">Opis projektu</label>
        <textarea name="description" rows="4" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none resize-y" placeholder="Opisz czego potrzebujesz..."></textarea>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="button" onclick="closeInquiryModal()" class="border border-white/20 hover:border-white text-white px-6 py-3 rounded-lg font-semibold flex-1 transition-colors">
          Anuluj
        </button>
        <button type="submit" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold flex-1 transition-colors">
          Wyślij zapytanie
        </button>
      </div>
      <div id="inquiry-modal-msg" class="hidden text-center text-sm"></div>
    </form>
  </div>
</div>
<% } %>

<script>
// --- Custom audio player (matching bank-glosow style) ---
var currentAudio = null;
var currentBtn = null;

function initSamplePlayer(btn) {
  btn.addEventListener('click', function() {
    var src = this.dataset.audio;
    var row = this.closest('.sample-row');
    var playIcon = this.querySelector('.play-icon');
    var pauseIcon = this.querySelector('.pause-icon');
    var bar = row.querySelector('.audio-bar');
    var timeEl = row.querySelector('.audio-time');
    var durEl = row.querySelector('.audio-duration');

    // Stop previous if different button
    if (currentAudio && currentBtn !== this) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentBtn.querySelector('.play-icon').classList.remove('hidden');
      currentBtn.querySelector('.pause-icon').classList.add('hidden');
      currentBtn.closest('.sample-row').querySelector('.audio-bar').style.width = '0%';
    }

    // Pause if same button playing
    if (currentAudio && currentBtn === this && !currentAudio.paused) {
      currentAudio.pause();
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      return;
    }

    // Create new audio or reuse
    if (!currentAudio || currentBtn !== this) {
      currentAudio = new Audio(src);
      currentBtn = this;

      currentAudio.addEventListener('loadedmetadata', function() {
        durEl.textContent = formatTime(currentAudio.duration);
      });
      currentAudio.addEventListener('timeupdate', function() {
        var pct = (currentAudio.currentTime / currentAudio.duration) * 100;
        bar.style.width = pct + '%';
        timeEl.textContent = formatTime(currentAudio.currentTime);
      });
      currentAudio.addEventListener('ended', function() {
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        bar.style.width = '0%';
        timeEl.textContent = '0:00';
      });

      // Click-to-seek on progress bar
      row.querySelector('.audio-progress').addEventListener('click', function(e) {
        if (currentAudio && currentBtn === btn) {
          var rect = this.getBoundingClientRect();
          var pct = (e.clientX - rect.left) / rect.width;
          currentAudio.currentTime = pct * currentAudio.duration;
        }
      });
    }

    currentAudio.play();
    playIcon.classList.add('hidden');
    pauseIcon.classList.remove('hidden');
  });
}

// Init all sample players
document.querySelectorAll('.sample-play-btn').forEach(function(btn) {
  initSamplePlayer(btn);
});

function formatTime(s) {
  var m = Math.floor(s / 60);
  var sec = Math.floor(s % 60);
  return m + ':' + (sec < 10 ? '0' : '') + sec;
}

// Lazy YouTube embed
function loadYT(el, ytId) {
  el.innerHTML = '<iframe class="w-full h-full absolute inset-0" src="https://www.youtube.com/embed/' + ytId + '?autoplay=1&rel=0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
}

// File upload label
function updateFileLabel(input) {
  var label = input.closest('label').querySelector('.file-label');
  if (input.files.length > 0) {
    label.textContent = input.files[0].name;
    label.classList.remove('text-gray-500');
    label.classList.add('text-white');
  } else {
    label.textContent = 'Brak zaznaczonych plików';
    label.classList.add('text-gray-500');
    label.classList.remove('text-white');
  }
}

// Inquiry form submit
(function() {
  var form = document.getElementById('inquiry-form');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    var btn = document.getElementById('inquiry-submit');
    var msg = document.getElementById('inquiry-msg');
    var origText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Wysyłanie...';
    msg.className = 'mt-4 text-center hidden';

    var formData = new FormData(form);

    fetch('/api/contact/inquiry-premium', {
      method: 'POST',
      body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        msg.textContent = data.message || 'Dziękujemy! Odpowiemy najszybciej jak to możliwe.';
        msg.className = 'mt-4 text-center text-accent font-medium';
        form.reset();
        var fileLabel = form.querySelector('.file-label');
        if (fileLabel) { fileLabel.textContent = 'Brak zaznaczonych plików'; fileLabel.className = 'text-gray-500 text-sm truncate file-label'; }
      } else {
        msg.textContent = data.error || 'Wystąpił błąd. Spróbuj ponownie.';
        msg.className = 'mt-4 text-center text-red-400 font-medium';
      }
    })
    .catch(function() {
      msg.textContent = 'Błąd połączenia. Spróbuj ponownie.';
      msg.className = 'mt-4 text-center text-red-400 font-medium';
    })
    .finally(function() {
      btn.disabled = false;
      btn.textContent = origText;
    });
  });
})();

// --- Lektor context data ---
var LEKTOR_NAME = '<%= lektor.name.replace(/'/g, "\\'") %>';
var LEKTOR_ID = '<%= lektor.id %>';
var LEKTOR_PRICES = <%- JSON.stringify(lektor.prices || {}) %>;
var LEKTOR_HIDE_PRICE = <%= lektor.hidePrice ? 'true' : 'false' %>;

// --- Modal: Oblicz koszt ---
function showTextInputModal() {
  var el = document.getElementById('text-input-modal');
  if (el) { el.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
}
function closeTextModal() {
  var el = document.getElementById('text-input-modal');
  if (el) { el.classList.add('hidden'); document.body.style.overflow = ''; }
}

function calculateFromText() {
  var text = document.getElementById('modal-text-input').value.trim();
  if (!text) { alert('Proszę wkleić tekst do obliczenia.'); return; }
  var ctx = { text: text, lektorName: LEKTOR_NAME, lektorId: LEKTOR_ID, timestamp: Date.now() };
  try { sessionStorage.setItem('kreatorContext', JSON.stringify(ctx)); } catch(e) {}
  closeTextModal();
  showPricingCalculator(ctx);
}

function goToKreatorWithLektor() {
  var ctx = { lektorName: LEKTOR_NAME, lektorId: LEKTOR_ID, returnUrl: window.location.pathname, timestamp: Date.now() };
  try { sessionStorage.setItem('kreatorContext', JSON.stringify(ctx)); } catch(e) {}
  window.location.href = '/#kreator';
}

// --- Modal: Zapytaj o wycenę ---
function showInquiryModal() {
  var el = document.getElementById('inquiry-modal');
  if (el) { el.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
}
function closeInquiryModal() {
  var el = document.getElementById('inquiry-modal');
  if (el) { el.classList.add('hidden'); document.body.style.overflow = ''; }
  var msg = document.getElementById('inquiry-modal-msg');
  if (msg) { msg.classList.add('hidden'); }
}

var inquiryModalForm = document.getElementById('inquiry-modal-form');
if (inquiryModalForm) inquiryModalForm.addEventListener('submit', function(e) {
  e.preventDefault();
  var fd = new FormData(e.target);
  var data = {};
  fd.forEach(function(v, k) { data[k] = v; });
  data.lektorName = LEKTOR_NAME;
  data.lektorId = LEKTOR_ID;
  // Include text from context if available
  try {
    var ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}');
    if (ctx.text) data.generatedText = ctx.text;
  } catch(ex) {}

  var submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Wysyłanie...';

  fetch('/api/contact/inquiry', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(function(r) { return r.json(); })
  .then(function(res) {
    var msg = document.getElementById('inquiry-modal-msg');
    msg.classList.remove('hidden');
    if (res.ok) {
      msg.className = 'mt-4 text-center text-sm text-green-400';
      msg.textContent = res.message || 'Dziękujemy! Odpowiemy w ciągu 2 godzin.';
      e.target.reset();
      setTimeout(closeInquiryModal, 2500);
    } else {
      msg.className = 'mt-4 text-center text-sm text-red-400';
      msg.textContent = res.error || 'Błąd wysyłania.';
    }
  })
  .catch(function() {
    var msg = document.getElementById('inquiry-modal-msg');
    msg.className = 'mt-4 text-center text-sm text-red-400';
    msg.textContent = 'Błąd połączenia.';
    msg.classList.remove('hidden');
  })
  .finally(function() {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Wyślij zapytanie';
  });
});

// --- Kalkulator cenowy ---
function showPricingCalculator(ctx) {
  var section = document.getElementById('kreator-pricing-section');
  var textDiv = document.getElementById('lektor-context-text');
  var calc = document.getElementById('pricing-calculator');
  if (!section || !textDiv || !calc || !ctx.text) return;

  textDiv.textContent = ctx.text;
  var wordCount = ctx.text.trim().split(/\s+/).length;

  if (LEKTOR_HIDE_PRICE) {
    calc.innerHTML = '<div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 text-center">' +
      '<p class="text-yellow-400 text-sm">Ten lektor wymaga indywidualnej wyceny</p>' +
      '<p class="text-gray-400 text-xs mt-1">Wyślij zapytanie poniżej</p>' +
    '</div>';
  } else if (LEKTOR_PRICES.ivr_100) {
    var estimatedPrice = '';
    if (wordCount <= 100) {
      estimatedPrice = LEKTOR_PRICES.ivr_100 + ' zł';
    } else if (wordCount <= 200 && LEKTOR_PRICES.ivr_200) {
      estimatedPrice = LEKTOR_PRICES.ivr_200 + ' zł';
    } else if (LEKTOR_PRICES.ivr_200plus && LEKTOR_PRICES.ivr_200plus !== 'wycena') {
      estimatedPrice = LEKTOR_PRICES.ivr_200plus + ' zł';
    } else {
      estimatedPrice = 'wycena indyw.';
    }

    calc.innerHTML =
      '<div class="grid grid-cols-2 gap-4">' +
        '<div class="bg-dark-700 rounded-lg p-4 text-center">' +
          '<div class="text-3xl font-bold text-white">' + wordCount + '</div>' +
          '<div class="text-xs text-gray-500 mt-1">Słów w tekście</div>' +
        '</div>' +
        '<div class="bg-dark-700 rounded-lg p-4 text-center">' +
          '<div class="text-3xl font-bold text-accent">' + estimatedPrice + '</div>' +
          '<div class="text-xs text-gray-500 mt-1">Szacowana cena (IVR)</div>' +
        '</div>' +
      '</div>' +
      '<p class="text-xs text-gray-500 text-center mt-2">Cena orientacyjna — może się różnić w zależności od typu nagrania</p>';
  } else {
    calc.innerHTML = '<div class="text-center"><p class="text-sm text-gray-400">Skontaktuj się, aby uzyskać wycenę</p></div>';
  }

  section.classList.remove('hidden');
}

function orderWithContext() {
  try {
    var ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}');
    ctx.lektorName = LEKTOR_NAME;
    ctx.lektorId = LEKTOR_ID;
    sessionStorage.setItem('kreatorContext', JSON.stringify(ctx));
  } catch(e) {}
  window.location.href = '/?action=order&lektor=' + LEKTOR_ID + '#kreator';
}

function inquiryWithContext() {
  try {
    var ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}');
    ctx.lektorName = LEKTOR_NAME;
    ctx.lektorId = LEKTOR_ID;
    sessionStorage.setItem('kreatorContext', JSON.stringify(ctx));
  } catch(e) {}
  window.location.href = '/?action=inquiry&lektor=' + LEKTOR_ID + '#kreator';
}

function clearPricingContext() {
  try { sessionStorage.removeItem('kreatorContext'); } catch(e) {}
  var section = document.getElementById('kreator-pricing-section');
  if (section) section.classList.add('hidden');
}

// --- Auto-detect context on page load ---
(function() {
  try {
    var ctxStr = sessionStorage.getItem('kreatorContext');
    if (!ctxStr) return;
    var ctx = JSON.parse(ctxStr);
    if (ctx.text) showPricingCalculator(ctx);
  } catch(e) {}
})();
</script>

<%- include('partials/foot') %>

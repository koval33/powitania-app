<%- include('partials/head') %>

<section class="py-10 md:py-16">
  <div class="max-w-5xl mx-auto px-4">

    <!-- Breadcrumb -->
    <nav class="text-sm mb-8">
      <a href="/" class="text-gray-500 hover:text-white transition-colors">Strona główna</a>
      <span class="text-gray-600 mx-2">/</span>
      <a href="/bank-glosow/" class="text-gray-500 hover:text-white transition-colors">Bank głosów</a>
      <span class="text-gray-600 mx-2">/</span>
      <span class="text-gray-300"><%= lektor.name %></span>
    </nav>

    <!-- Profil: zdjęcie + info -->
    <div class="flex flex-col md:flex-row gap-8 md:gap-12">

      <!-- Lewa kolumna: zdjęcie + tagi -->
      <div class="flex-shrink-0">
        <div class="w-48 h-48 md:w-56 md:h-56 rounded-2xl overflow-hidden border-2 border-white/10 mx-auto md:mx-0">
          <img src="<%= lektor.photo %>" alt="<%= lektor.name %>" class="w-full h-full object-cover">
        </div>
        <div class="flex flex-wrap gap-2 mt-4 justify-center md:justify-start">
          <% if (lektor.famous) { %>
            <span class="bg-yellow-500/10 text-yellow-400 text-xs font-semibold px-3 py-1 rounded-full border border-yellow-500/20">Znani i lubiani</span>
          <% } %>
          <% if (lektor.native) { %>
            <span class="bg-blue-500/10 text-blue-400 text-xs font-semibold px-3 py-1 rounded-full border border-blue-500/20">Native speaker</span>
          <% } %>
          <span class="bg-dark-700 text-gray-400 text-xs font-medium px-3 py-1 rounded-full border border-white/10">
            <%= lektor.gender === 'm' ? 'Mężczyzna' : 'Kobieta' %>
          </span>
          <span class="bg-dark-700 text-gray-400 text-xs font-medium px-3 py-1 rounded-full border border-white/10">
            <%= lektor.age %>
          </span>
        </div>
      </div>

      <!-- Prawa kolumna: dane -->
      <div class="flex-1 min-w-0">
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-3"><%= lektor.name %></h1>

        <% if (lektor.description) { %>
          <p class="text-gray-400 leading-relaxed mb-4"><%= lektor.description %></p>
        <% } %>

        <!-- Meta info — kompaktowo -->
        <div class="flex flex-wrap items-center gap-x-4 gap-y-1.5 text-sm text-gray-400 mb-4">
          <span><%= lektor.languages.join(', ') %></span>
          <span class="text-gray-600">·</span>
          <span>Realizacja: <span class="text-white"><%= lektor.turnaround || '24-48h' %></span></span>
          <% if (lektor.applications && lektor.applications.length > 0) { %>
          <span class="text-gray-600">·</span>
          <% lektor.applications.forEach(function(app) { %>
            <span class="text-xs bg-accent/10 text-accent px-2 py-0.5 rounded-full"><%= app %></span>
          <% }); %>
          <% } %>
        </div>

        <!-- PRÓBKI GŁOSOWE — od razu w kolumnie -->
        <%
          var allAudio = [];
          var seenUrls = {};
          var samples = lektor.samples || [];
          if (lektor.audio) {
            allAudio.push({ name: (samples[0] && samples[0].name) || 'Próbka główna', url: lektor.audio });
            seenUrls[lektor.audio] = true;
            if (samples.length > 0 && samples[0].url) seenUrls[samples[0].url] = true;
          }
          samples.forEach(function(s) {
            if (!s.url) return;
            var isVideo = s.url.includes('youtu') || s.url.includes('vimeo');
            if (!isVideo && !seenUrls[s.url]) {
              allAudio.push(s);
              seenUrls[s.url] = true;
            }
          });
          var videoSamples = (lektor.samples || []).filter(function(s) {
            return s.url && (s.url.includes('youtu') || s.url.includes('vimeo'));
          });
        %>

        <% if (allAudio.length > 0) { %>
        <div class="space-y-2 mb-5">
          <% allAudio.forEach(function(sample, idx) { %>
          <div class="sample-row bg-dark-800/60 rounded-lg border border-white/5 overflow-hidden">
            <div class="flex items-center gap-3 p-3">
              <button class="sample-play-btn w-10 h-10 flex-shrink-0 bg-accent hover:bg-accent-light rounded-full flex items-center justify-center transition-colors" data-audio="<%= sample.url %>">
                <svg class="play-icon w-4 h-4 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg class="pause-icon w-4 h-4 text-white hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
              </button>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-white font-medium truncate mb-1"><%= sample.name || ('Próbka ' + (idx + 1)) %></div>
                <div class="audio-progress w-full h-1.5 bg-dark-600 rounded-full overflow-hidden cursor-pointer">
                  <div class="audio-bar h-full bg-accent rounded-full transition-all" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-0.5">
                  <span class="audio-time text-xs text-gray-500">0:00</span>
                  <span class="audio-duration text-xs text-gray-500">--:--</span>
                </div>
              </div>
              <a href="<%= sample.url %>" download title="Pobierz MP3" class="w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full text-gray-500 hover:text-white hover:bg-dark-600 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
              </a>
            </div>
          </div>
          <% }); %>
        </div>
        <% } %>

        <!-- CTA -->
        <div id="lektor-cta-section" class="flex flex-col gap-3">
          <% if (!lektor.hidePrice) { %>
          <button onclick="showOrderModal()" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors inline-flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"/></svg>
            Wyceń nagranie z tym lektorem
          </button>
          <button onclick="showInquiryModal()" class="text-gray-400 hover:text-accent text-sm transition-colors text-center">
            Zapytaj o wycenę
          </button>
          <% } else { %>
          <a href="#zapytanie" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold text-center transition-colors inline-flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75"/></svg>
            Zapytaj o wycenę
          </a>
          <% } %>
        </div>

        <!-- INTELIGENTNY WIZARD WYCENY (widoczny gdy kontekst z kreatora) -->
        <div id="pricing-wizard" class="mt-6 hidden">
          <div class="bg-dark-800 rounded-2xl border-2 border-accent/30 p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                <h3 class="text-lg font-bold text-white">Wycena nagrania</h3>
              </div>
              <button onclick="clearPricingContext()" class="text-gray-500 hover:text-white transition-colors" title="Zamknij">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
            <!-- Podgląd tekstu -->
            <div class="bg-dark-900/50 rounded-lg p-3 mb-4">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-gray-500">Twój tekst:</span>
                <span id="wizard-word-count" class="text-xs text-accent font-medium"></span>
              </div>
              <div id="wizard-text-preview" class="text-gray-300 text-sm leading-relaxed max-h-24 overflow-y-auto"></div>
            </div>
            <!-- Typ nagrania (jeśli nie przyszedł z kreatora) -->
            <div id="wizard-service-type" class="hidden mb-4">
              <label class="block text-white font-semibold mb-2 text-sm">Typ nagrania</label>
              <select id="wizard-service-select" onchange="updateWizardPricing()" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-accent focus:outline-none">
                <option value="">— wybierz typ nagrania —</option>
                <option value="ivr">Zapowiedzi telefoniczne (IVR)</option>
                <option value="radio">Spot radiowy</option>
                <option value="tv">Spot telewizyjny</option>
                <option value="social">Social media</option>
                <option value="elearning">E-learning / szkolenia</option>
                <option value="film">Narracja filmowa</option>
                <option value="audiobook">Audiobook</option>
                <option value="podcast">Podcast (intro/outro)</option>
              </select>
            </div>
            <!-- Dynamiczne pytania per serviceType -->
            <div id="wizard-questions"></div>
            <!-- Wycena -->
            <div id="wizard-pricing" class="hidden"></div>
            <!-- CTA + formularz zamówienia — pojawi się dopiero po wycenie -->
            <div id="wizard-cta" class="hidden mt-5">
              <div id="wizard-order-form" class="border-t border-white/10 pt-4">
                <h4 class="text-white font-bold mb-4 flex items-center gap-2">
                  <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
                  Dane do zamówienia
                </h4>
                <div class="space-y-3">
                  <div>
                    <label class="block text-white text-sm font-medium mb-1">Nazwa firmy *</label>
                    <input type="text" id="wiz-firmName" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="Firma Sp. z o.o.">
                  </div>
                  <div class="grid sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-white text-sm font-medium mb-1">Imię i nazwisko *</label>
                      <input type="text" id="wiz-name" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="Jan Kowalski">
                    </div>
                    <div>
                      <label class="block text-white text-sm font-medium mb-1">NIP</label>
                      <input type="text" id="wiz-nip" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="123-456-78-90">
                    </div>
                  </div>
                  <div>
                    <label class="block text-white text-sm font-medium mb-1">Adres *</label>
                    <input type="text" id="wiz-street" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm mb-2" placeholder="ul. Przykładowa 10/2">
                    <div class="grid grid-cols-3 gap-2">
                      <input type="text" id="wiz-zipCode" class="bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="00-000">
                      <input type="text" id="wiz-city" class="col-span-2 bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="Warszawa">
                    </div>
                  </div>
                  <div class="grid sm:grid-cols-2 gap-3">
                    <div>
                      <label class="block text-white text-sm font-medium mb-1">Email *</label>
                      <input type="email" id="wiz-email" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="jan@firma.pl">
                    </div>
                    <div>
                      <label class="block text-white text-sm font-medium mb-1">Telefon</label>
                      <input type="tel" id="wiz-phone" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="+48 600 000 000">
                    </div>
                  </div>
                  <div>
                    <label class="block text-white text-sm font-medium mb-1">Uwagi</label>
                    <textarea id="wiz-notes" rows="2" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm resize-y" placeholder="Dodatkowe informacje..."></textarea>
                  </div>
                </div>
                <button onclick="submitWizardOrder()" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold w-full transition-colors mt-4">
                  Zamów nagranie
                </button>
                <div id="wizard-order-msg" class="hidden text-center text-sm mt-2"></div>
                <button onclick="inquiryWithContext()" class="text-gray-400 hover:text-accent text-sm transition-colors text-center w-full mt-2">
                  Zapytaj o szczegóły
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- VIDEO (pełna szerokość, pod profilem) -->
    <%
      var videoSamples = (lektor.samples || []).filter(function(s) {
        return s.url && (s.url.includes('youtu') || s.url.includes('vimeo'));
      });
    %>

    <% if (videoSamples.length > 0) { %>
    <div class="mt-10">
      <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/><path fill="#fff" d="M9.545 15.568V8.432L15.818 12z"/></svg>
        Realizacje wideo
      </h3>
      <div class="grid sm:grid-cols-2 gap-4">
        <% videoSamples.forEach(function(video) {
          var ytId = '';
          var url = video.url || '';
          if (url.includes('youtu.be/')) {
            ytId = url.split('youtu.be/')[1].split(/[?&#]/)[0];
          } else if (url.includes('youtube.com/watch')) {
            var match = url.match(/[?&]v=([^&#]+)/);
            if (match) ytId = match[1];
          } else if (url.includes('youtube.com/shorts/')) {
            ytId = url.split('shorts/')[1].split(/[?&#]/)[0];
          }
        %>
        <div class="bg-dark-800 rounded-xl border border-white/5 overflow-hidden group">
          <% if (ytId) { %>
          <div class="aspect-video relative cursor-pointer" onclick="loadYT(this, '<%= ytId %>')">
            <img src="https://img.youtube.com/vi/<%= ytId %>/mqdefault.jpg" alt="<%= video.name %>" class="w-full h-full object-cover" loading="lazy">
            <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors flex items-center justify-center">
              <div class="w-14 h-14 bg-red-600 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                <svg class="w-6 h-6 text-white ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              </div>
            </div>
          </div>
          <% } else { %>
          <div class="aspect-video bg-dark-700 flex items-center justify-center">
            <a href="<%= video.url %>" target="_blank" rel="noopener" class="text-accent hover:text-accent-light">
              <svg class="w-12 h-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"/></svg>
            </a>
          </div>
          <% } %>
          <div class="p-3">
            <div class="text-sm text-white font-medium"><%= video.name %></div>
          </div>
        </div>
        <% }); %>
      </div>
    </div>
    <% } %>

    <!-- FORMULARZ ZAPYTANIA (dla lektorów z hidePrice) -->
    <% if (lektor.hidePrice) { %>
    <div class="mt-12" id="zapytanie">
      <div class="max-w-2xl mx-auto bg-dark-800 rounded-2xl border border-white/5 p-8">
        <p class="text-gray-300 leading-relaxed mb-8">
          Udział artysty w projekcie jest potwierdzany indywidualnie. Proszę o przesłanie możliwie jak najszerszej informacji na temat projektu (typ nagrania, pole jego eksploatacji, czas na jaki ma zostać udzielona licencja) a my wrócimy z informacją na temat zainteresowania artysty i kosztów.
        </p>
        <hr class="border-white/10 mb-8">

        <form id="inquiry-form" enctype="multipart/form-data">
          <input type="hidden" name="lektorName" value="<%= lektor.name %>">
          <input type="hidden" name="lektorId" value="<%= lektor.id %>">

          <div class="mb-6">
            <label class="block text-white font-semibold mb-2">Opis projektu</label>
            <textarea name="description" rows="5" required
              class="w-full bg-dark-700 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none resize-y transition-colors"
              placeholder="Informacje o projekcie: typ nagrania, pole jego eksploatacji, czas na jaki ma zostać udzielona licencja..."></textarea>
          </div>

          <div class="grid sm:grid-cols-2 gap-6 mb-6">
            <div>
              <label class="block text-white font-semibold mb-2">Email:</label>
              <input type="email" name="email" required
                class="w-full bg-dark-700 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none transition-colors"
                placeholder="twoj@email.pl">
            </div>
            <div>
              <label class="block text-white font-semibold mb-2">Załącznik do formularza:</label>
              <label class="flex items-center gap-3 cursor-pointer bg-dark-700 border border-white/10 rounded-xl px-4 py-3 hover:border-white/20 transition-colors">
                <span class="bg-dark-600 text-gray-300 text-sm px-3 py-1 rounded-lg border border-white/10">Wybierz plik</span>
                <span class="text-gray-500 text-sm truncate file-label">Brak zaznaczonych plików</span>
                <input type="file" name="attachment" class="hidden" accept=".pdf,.doc,.docx,.txt,.rtf,.odt,.mp3,.wav,.zip" onchange="updateFileLabel(this)">
              </label>
            </div>
          </div>

          <div class="flex justify-end">
            <button type="submit" id="inquiry-submit"
              class="bg-accent hover:bg-accent-light text-white px-8 py-3 rounded-lg font-bold text-sm uppercase tracking-wider transition-colors">
              Wyślij zapytanie
            </button>
          </div>

          <div id="inquiry-msg" class="mt-4 text-center hidden"></div>
        </form>
      </div>
    </div>
    <% } %>

    <!-- CENNIK (jeśli nie ukryty) -->
    <% if (!lektor.hidePrice && lektor.prices) { %>
    <div class="mt-12" id="lektor-cennik-section">
      <h2 class="text-2xl font-bold text-white mb-6">Cennik</h2>

      <div class="grid md:grid-cols-3 gap-6">

        <!-- Powitanie / IVR -->
        <% if (lektor.prices.ivr_100) { %>
        <div class="bg-dark-800 rounded-xl border border-white/5 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 bg-emerald-600/10 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"/></svg>
            </div>
            <h3 class="text-white font-bold">Powitanie / IVR</h3>
          </div>
          <table class="w-full text-sm">
            <tbody class="divide-y divide-white/5">
              <tr>
                <td class="py-2 text-gray-400">do 100 słów</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.ivr_100 %> zł netto</td>
              </tr>
              <% if (lektor.prices.ivr_200) { %>
              <tr>
                <td class="py-2 text-gray-400">101-200 słów</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.ivr_200 %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_200plus && lektor.prices.ivr_200plus !== 'wycena') { %>
              <tr>
                <td class="py-2 text-gray-400">pow. 200 słów</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.ivr_200plus %> zł netto</td>
              </tr>
              <% } else { %>
              <tr>
                <td class="py-2 text-gray-400">pow. 200 słów</td>
                <td class="py-2 text-right text-accent text-xs font-medium">wycena indyw.</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_guarantee_100) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Gwarancja modyfikacji do 100 słów</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_guarantee_100 %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_guarantee_100plus) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Gwarancja modyfikacji pow. 100 słów</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_guarantee_100plus %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_melody) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Melodia w tle</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_melody %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.ivr_bilingual) { %>
              <tr>
                <td class="py-2 text-gray-500 text-xs">Pakiet dwujęzyczny</td>
                <td class="py-2 text-right text-gray-300 text-xs"><%= lektor.prices.ivr_bilingual %> zł netto</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <% } %>

        <!-- Spot reklamowy -->
        <% if (lektor.prices.spot_radio_local) { %>
        <div class="bg-dark-800 rounded-xl border border-white/5 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 bg-red-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z"/></svg>
            </div>
            <h3 class="text-white font-bold">Spot reklamowy</h3>
          </div>
          <table class="w-full text-sm">
            <tbody class="divide-y divide-white/5">
              <tr>
                <td class="py-2 text-gray-400">Radio — lokalny</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_radio_local %> zł netto</td>
              </tr>
              <% if (lektor.prices.spot_radio_national) { %>
              <tr>
                <td class="py-2 text-gray-400">Radio — ogólnokrajowy</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_radio_national %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_tv_local) { %>
              <tr>
                <td class="py-2 text-gray-400">TV — lokalny</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_tv_local %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_tv_national) { %>
              <tr>
                <td class="py-2 text-gray-400">TV — ogólnokrajowy</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_tv_national %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_social_1min) { %>
              <tr>
                <td class="py-2 text-gray-400">Social media — do 1 min</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_social_1min %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.spot_social_2min) { %>
              <tr>
                <td class="py-2 text-gray-400">Social media — do 2 min</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.spot_social_2min %> zł netto</td>
              </tr>
              <% } %>
            </tbody>
          </table>
          <p class="text-xs text-gray-600 mt-3">Stawka uwzględnia licencję na okres do 12 mies.</p>
        </div>
        <% } %>

        <!-- Narracja do filmu -->
        <% if (lektor.prices.narration_1page) { %>
        <div class="bg-dark-800 rounded-xl border border-white/5 p-6">
          <div class="flex items-center gap-2 mb-4">
            <div class="w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/></svg>
            </div>
            <h3 class="text-white font-bold">Narracja do filmu</h3>
          </div>
          <table class="w-full text-sm">
            <tbody class="divide-y divide-white/5">
              <tr>
                <td class="py-2 text-gray-400">1 strona A4</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.narration_1page %> zł netto</td>
              </tr>
              <% if (lektor.prices.narration_2pages) { %>
              <tr>
                <td class="py-2 text-gray-400">2 strony A4</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.narration_2pages %> zł netto</td>
              </tr>
              <% } %>
              <% if (lektor.prices.narration_3pages) { %>
              <tr>
                <td class="py-2 text-gray-400">3 strony A4</td>
                <td class="py-2 text-right text-white font-semibold"><%= lektor.prices.narration_3pages %> zł netto</td>
              </tr>
              <% } %>
              <tr>
                <td class="py-2 text-gray-400">pow. 3 stron A4</td>
                <td class="py-2 text-right text-accent text-xs font-medium">wycena indyw.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <% } %>

      </div>
    </div>
    <% } %>

    <!-- Inni lektorzy -->
    <% if (similar && similar.length > 0) { %>
    <div class="mt-16">
      <h2 class="text-2xl font-bold text-white mb-6">Podobni lektorzy</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-5">
        <% similar.forEach(function(s) { %>
        <a href="/lektor/<%= s.id %>/" class="text-center group">
          <img src="<%= s.photo %>" alt="<%= s.name %>" class="w-20 h-20 rounded-full mx-auto object-cover border-2 border-white/10 group-hover:border-accent/50 transition-all mb-2" loading="lazy">
          <div class="text-white text-sm font-medium group-hover:text-accent transition-colors truncate"><%= s.name %></div>
          <div class="text-xs text-gray-600"><%= s.gender === 'm' ? 'Lektor' : 'Lektorka' %></div>
        </a>
        <% }); %>
      </div>
    </div>
    <% } %>

  </div>
</section>

<% if (!lektor.hidePrice) { %>
<!-- MODAL: Zamów nagranie -->
<div id="order-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-dark-800 rounded-2xl border border-white/10 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-dark-800 border-b border-white/10 p-6 flex items-center justify-between rounded-t-2xl">
      <h3 class="text-2xl font-bold text-white">Zamów nagranie — <span class="text-accent"><%= lektor.name %></span></h3>
      <button onclick="closeOrderModal()" class="text-gray-400 hover:text-white transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="p-6">
      <!-- Krok 1: Tekst -->
      <div id="modal-step-text">
        <p class="text-gray-400 mb-4 text-sm">Masz gotowy tekst? Wklej go poniżej. Jeśli nie — skorzystaj z kreatora.</p>
        <textarea id="modal-text-input" rows="5" placeholder="Wklej tutaj swój tekst do nagrania..." class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none resize-y mb-3"></textarea>

        <!-- Wybór typu nagrania -->
        <div class="mb-4">
          <label class="block text-white font-semibold mb-2 text-sm">Typ nagrania *</label>
          <select id="modal-service-select" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white focus:border-accent focus:outline-none">
            <option value="">— wybierz typ nagrania —</option>
            <option value="ivr">Zapowiedzi telefoniczne (IVR)</option>
            <option value="radio">Spot radiowy</option>
            <option value="tv">Spot telewizyjny</option>
            <option value="social">Social media</option>
            <option value="elearning">E-learning / szkolenia</option>
            <option value="film">Narracja filmowa</option>
            <option value="audiobook">Audiobook</option>
            <option value="podcast">Podcast (intro/outro)</option>
          </select>
        </div>

        <!-- Dynamiczne pytania per serviceType -->
        <div id="modal-questions"></div>

        <!-- Wycena inline -->
        <div id="modal-pricing" class="hidden"></div>

        <!-- Wycena oblicza się automatycznie po wpisaniu tekstu i wyborze typu -->

        <!-- Formularz zamówienia po wycenie -->
        <div id="modal-order-cta" class="hidden mt-4">
          <div class="border-t border-white/10 pt-4">
            <h4 class="text-white font-bold mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
              Dane do zamówienia
            </h4>
            <div class="space-y-3">
              <div>
                <label class="block text-white text-sm font-medium mb-1">Nazwa firmy *</label>
                <input type="text" id="mod-firmName" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="Firma Sp. z o.o.">
              </div>
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-white text-sm font-medium mb-1">Imię i nazwisko *</label>
                  <input type="text" id="mod-name" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="Jan Kowalski">
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-1">NIP</label>
                  <input type="text" id="mod-nip" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="123-456-78-90">
                </div>
              </div>
              <div>
                <label class="block text-white text-sm font-medium mb-1">Adres *</label>
                <input type="text" id="mod-street" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm mb-2" placeholder="ul. Przykładowa 10/2">
                <div class="grid grid-cols-3 gap-2">
                  <input type="text" id="mod-zipCode" class="bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="00-000">
                  <input type="text" id="mod-city" class="col-span-2 bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="Warszawa">
                </div>
              </div>
              <div class="grid sm:grid-cols-2 gap-3">
                <div>
                  <label class="block text-white text-sm font-medium mb-1">Email *</label>
                  <input type="email" id="mod-email" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="jan@firma.pl">
                </div>
                <div>
                  <label class="block text-white text-sm font-medium mb-1">Telefon</label>
                  <input type="tel" id="mod-phone" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm" placeholder="+48 600 000 000">
                </div>
              </div>
              <div>
                <label class="block text-white text-sm font-medium mb-1">Uwagi</label>
                <textarea id="mod-notes" rows="2" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-2.5 text-white placeholder-gray-600 focus:border-accent focus:outline-none text-sm resize-y" placeholder="Dodatkowe informacje..."></textarea>
              </div>
            </div>
            <button onclick="submitModalOrder()" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold w-full transition-colors mt-4">
              Zamów nagranie
            </button>
            <div id="modal-order-msg" class="hidden text-center text-sm mt-2"></div>
          </div>
        </div>

        <div class="mt-4 pt-4 border-t border-white/5 text-center">
          <button onclick="goToKreatorWithLektor()" class="text-accent hover:text-accent-light text-sm transition-colors inline-flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
            Nie mam tekstu — wygeneruj w kreatorze
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Zapytaj o wycenę -->
<div id="inquiry-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
  <div class="bg-dark-800 rounded-2xl border border-white/10 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-dark-800 border-b border-white/10 p-6 flex items-center justify-between rounded-t-2xl">
      <h3 class="text-2xl font-bold text-white">Zapytaj o wycenę</h3>
      <button onclick="closeInquiryModal()" class="text-gray-400 hover:text-white transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form id="inquiry-modal-form" class="p-6 space-y-4">
      <div>
        <label class="block text-white font-semibold mb-2 text-sm">Imię i nazwisko</label>
        <input type="text" name="name" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none" placeholder="Jan Kowalski">
      </div>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-white font-semibold mb-2 text-sm">Email *</label>
          <input type="email" name="email" required class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none" placeholder="jan@firma.pl">
        </div>
        <div>
          <label class="block text-white font-semibold mb-2 text-sm">Telefon</label>
          <input type="tel" name="phone" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none" placeholder="+48 600 000 000">
        </div>
      </div>
      <div>
        <label class="block text-white font-semibold mb-2 text-sm">Opis projektu</label>
        <textarea name="description" rows="4" class="w-full bg-dark-700 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:outline-none resize-y" placeholder="Opisz czego potrzebujesz..."></textarea>
      </div>
      <div class="flex gap-3 pt-2">
        <button type="button" onclick="closeInquiryModal()" class="border border-white/20 hover:border-white text-white px-6 py-3 rounded-lg font-semibold flex-1 transition-colors">
          Anuluj
        </button>
        <button type="submit" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-semibold flex-1 transition-colors">
          Wyślij zapytanie
        </button>
      </div>
      <div id="inquiry-modal-msg" class="hidden text-center text-sm"></div>
    </form>
  </div>
</div>
<% } %>

<script>
// --- Custom audio player (matching bank-glosow style) ---
var currentAudio = null;
var currentBtn = null;

function initSamplePlayer(btn) {
  btn.addEventListener('click', function() {
    var src = this.dataset.audio;
    var row = this.closest('.sample-row');
    var playIcon = this.querySelector('.play-icon');
    var pauseIcon = this.querySelector('.pause-icon');
    var bar = row.querySelector('.audio-bar');
    var timeEl = row.querySelector('.audio-time');
    var durEl = row.querySelector('.audio-duration');

    // Stop previous if different button
    if (currentAudio && currentBtn !== this) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentBtn.querySelector('.play-icon').classList.remove('hidden');
      currentBtn.querySelector('.pause-icon').classList.add('hidden');
      currentBtn.closest('.sample-row').querySelector('.audio-bar').style.width = '0%';
    }

    // Pause if same button playing
    if (currentAudio && currentBtn === this && !currentAudio.paused) {
      currentAudio.pause();
      playIcon.classList.remove('hidden');
      pauseIcon.classList.add('hidden');
      return;
    }

    // Create new audio or reuse
    if (!currentAudio || currentBtn !== this) {
      currentAudio = new Audio(src);
      currentBtn = this;

      currentAudio.addEventListener('loadedmetadata', function() {
        durEl.textContent = formatTime(currentAudio.duration);
      });
      currentAudio.addEventListener('timeupdate', function() {
        var pct = (currentAudio.currentTime / currentAudio.duration) * 100;
        bar.style.width = pct + '%';
        timeEl.textContent = formatTime(currentAudio.currentTime);
      });
      currentAudio.addEventListener('ended', function() {
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        bar.style.width = '0%';
        timeEl.textContent = '0:00';
      });

      // Click-to-seek on progress bar
      row.querySelector('.audio-progress').addEventListener('click', function(e) {
        if (currentAudio && currentBtn === btn) {
          var rect = this.getBoundingClientRect();
          var pct = (e.clientX - rect.left) / rect.width;
          currentAudio.currentTime = pct * currentAudio.duration;
        }
      });
    }

    currentAudio.play();
    playIcon.classList.add('hidden');
    pauseIcon.classList.remove('hidden');
  });
}

// Init all sample players
document.querySelectorAll('.sample-play-btn').forEach(function(btn) {
  initSamplePlayer(btn);
});

function formatTime(s) {
  var m = Math.floor(s / 60);
  var sec = Math.floor(s % 60);
  return m + ':' + (sec < 10 ? '0' : '') + sec;
}

// Lazy YouTube embed
function loadYT(el, ytId) {
  el.innerHTML = '<iframe class="w-full h-full absolute inset-0" src="https://www.youtube.com/embed/' + ytId + '?autoplay=1&rel=0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
}

// File upload label
function updateFileLabel(input) {
  var label = input.closest('label').querySelector('.file-label');
  if (input.files.length > 0) {
    label.textContent = input.files[0].name;
    label.classList.remove('text-gray-500');
    label.classList.add('text-white');
  } else {
    label.textContent = 'Brak zaznaczonych plików';
    label.classList.add('text-gray-500');
    label.classList.remove('text-white');
  }
}

// Inquiry form submit
(function() {
  var form = document.getElementById('inquiry-form');
  if (!form) return;

  form.addEventListener('submit', function(e) {
    e.preventDefault();
    var btn = document.getElementById('inquiry-submit');
    var msg = document.getElementById('inquiry-msg');
    var origText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Wysyłanie...';
    msg.className = 'mt-4 text-center hidden';

    var formData = new FormData(form);

    fetch('/api/contact/inquiry-premium', {
      method: 'POST',
      body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.ok) {
        msg.textContent = data.message || 'Dziękujemy! Odpowiemy najszybciej jak to możliwe.';
        msg.className = 'mt-4 text-center text-accent font-medium';
        form.reset();
        var fileLabel = form.querySelector('.file-label');
        if (fileLabel) { fileLabel.textContent = 'Brak zaznaczonych plików'; fileLabel.className = 'text-gray-500 text-sm truncate file-label'; }
      } else {
        msg.textContent = data.error || 'Wystąpił błąd. Spróbuj ponownie.';
        msg.className = 'mt-4 text-center text-red-400 font-medium';
      }
    })
    .catch(function() {
      msg.textContent = 'Błąd połączenia. Spróbuj ponownie.';
      msg.className = 'mt-4 text-center text-red-400 font-medium';
    })
    .finally(function() {
      btn.disabled = false;
      btn.textContent = origText;
    });
  });
})();

// --- Lektor context data ---
var LEKTOR_NAME = '<%= lektor.name.replace(/'/g, "\\'") %>';
var LEKTOR_ID = '<%= lektor.id %>';
var LEKTOR_PRICES = <%- JSON.stringify(lektor.prices || {}) %>;
var LEKTOR_HIDE_PRICE = <%= lektor.hidePrice ? 'true' : 'false' %>;

// --- PRICING MAP: mapowanie serviceType → logika wyceny ---
var PRICING_MAP = {
  ivr: {
    label: 'Zapowiedzi telefoniczne (IVR)',
    method: 'wordcount',
    tiers: [
      { max: 100, field: 'ivr_100', label: 'do 100 slow' },
      { max: 200, field: 'ivr_200', label: '101-200 slow' },
      { max: Infinity, field: 'ivr_200plus', label: 'pow. 200 slow' }
    ],
    addons: [
      { field: 'ivr_guarantee_100', label: 'gwarancja bezpłatnej modyfikacji nagrania w okresie 12 m-cy', tooltip: 'Liczba słów w zleceniu modyfikacji nie może być większa niż w nagraniu pierwotnym.', condition: function(w) { return w <= 100; } },
      { field: 'ivr_guarantee_100plus', label: 'gwarancja bezpłatnej modyfikacji nagrania w okresie 12 m-cy', tooltip: 'Liczba słów w zleceniu modyfikacji nie może być większa niż w nagraniu pierwotnym.', condition: function(w) { return w > 100; } },
      { field: 'ivr_melody', label: 'Melodia w tle' }
    ],
    note: null
  },
  radio: {
    label: 'Spot radiowy',
    method: 'choice',
    options: [
      { field: 'spot_radio_local', label: 'Reklama lokalna' },
      { field: 'spot_radio_national', label: 'Reklama ogolnokrajowa' }
    ],
    note: 'Stawka uwzgl. licencje na okres do 12 mies.'
  },
  tv: {
    label: 'Spot telewizyjny',
    method: 'choice',
    options: [
      { field: 'spot_tv_local', label: 'Reklama lokalna' },
      { field: 'spot_tv_national', label: 'Reklama ogolnokrajowa' }
    ],
    note: 'Stawka uwzgl. licencje na okres do 12 mies.'
  },
  social: {
    label: 'Social media',
    method: 'choice',
    options: [
      { field: 'spot_social_1min', label: 'Do 1 minuty' },
      { field: 'spot_social_2min', label: 'Do 2 minut' }
    ],
    note: 'Stawka uwzgl. licencje na okres do 12 mies.'
  },
  elearning: {
    label: 'E-learning / szkolenia',
    method: 'pages',
    tiers: [
      { max: 1, field: 'narration_1page', label: '1 strona A4' },
      { max: 2, field: 'narration_2pages', label: '2 strony A4' },
      { max: 3, field: 'narration_3pages', label: '3 strony A4' },
      { max: Infinity, field: 'narration_3plus', label: 'pow. 3 stron A4' }
    ]
  },
  film: {
    label: 'Narracja filmowa',
    method: 'pages',
    tiers: [
      { max: 1, field: 'narration_1page', label: '1 strona A4' },
      { max: 2, field: 'narration_2pages', label: '2 strony A4' },
      { max: 3, field: 'narration_3pages', label: '3 strony A4' },
      { max: Infinity, field: 'narration_3plus', label: 'pow. 3 stron A4' }
    ]
  },
  audiobook: {
    label: 'Audiobook',
    method: 'pages',
    tiers: [
      { max: 1, field: 'narration_1page', label: '1 strona A4' },
      { max: 2, field: 'narration_2pages', label: '2 strony A4' },
      { max: 3, field: 'narration_3pages', label: '3 strony A4' },
      { max: Infinity, field: 'narration_3plus', label: 'pow. 3 stron A4' }
    ]
  },
  podcast: {
    label: 'Podcast (intro/outro)',
    method: 'pages',
    tiers: [
      { max: 1, field: 'narration_1page', label: '1 strona A4' },
      { max: 2, field: 'narration_2pages', label: '2 strony A4' },
      { max: 3, field: 'narration_3pages', label: '3 strony A4' },
      { max: Infinity, field: 'narration_3plus', label: 'pow. 3 stron A4' }
    ]
  }
};

// Mapowanie kreator serviceType → PRICING_MAP key
var SERVICE_TYPE_MAP = {
  'ivr': 'ivr',
  'powitania': 'ivr',
  'radio': 'radio',
  'tv': 'tv',
  'social': 'social',
  'elearning': 'elearning',
  'film': 'film',
  'audiobook': 'audiobook',
  'podcast': 'podcast'
};

// --- Helpers ---
function countWords(text) {
  // Usun oznaczenia sekcji w ** ** (np. **Powitanie:**) — to nie tekst do nagrania
  var cleaned = text.replace(/\*\*[^*]*\*\*/g, '');
  return cleaned.trim().split(/\s+/).filter(function(w) { return w.length > 0; }).length;
}

function wordsToPages(words) {
  return Math.ceil(words / 250 * 10) / 10; // ~250 slow = 1 strona A4, zaokr. do 0.1
}

// --- Inteligentna wycena ---
function calculatePrice(serviceType, wordCount, options) {
  var cfg = PRICING_MAP[serviceType];
  if (!cfg) return null;

  var result = { basePrice: null, label: '', addons: [], note: cfg.note || null, needsCustomQuote: false };

  if (cfg.method === 'wordcount') {
    // IVR — cena z tieru wg liczby slow
    for (var i = 0; i < cfg.tiers.length; i++) {
      var tier = cfg.tiers[i];
      if (wordCount <= tier.max) {
        var price = LEKTOR_PRICES[tier.field];
        if (price && price !== 'wycena') {
          result.basePrice = parseInt(price);
          result.label = tier.label;
        } else {
          result.needsCustomQuote = true;
          result.label = tier.label;
        }
        break;
      }
    }
    // Addony
    if (cfg.addons) {
      cfg.addons.forEach(function(addon) {
        if (addon.condition && !addon.condition(wordCount)) return;
        var addonPrice = LEKTOR_PRICES[addon.field];
        if (addonPrice) {
          result.addons.push({ field: addon.field, label: addon.label, price: parseInt(addonPrice), tooltip: addon.tooltip || null });
        }
      });
    }
    // Pakiet dwujezyczny — automatycznie gdy 2 jezyki
    if (options && options.bilingual) {
      var bilingualPrice = LEKTOR_PRICES['ivr_bilingual'];
      if (bilingualPrice) {
        result.bilingualPrice = parseInt(bilingualPrice);
      }
    }
  } else if (cfg.method === 'choice') {
    // Radio/TV/Social — klient wybiera opcje
    if (options && options.choiceField) {
      var choicePrice = LEKTOR_PRICES[options.choiceField];
      if (choicePrice) {
        result.basePrice = parseInt(choicePrice);
        var chosenOpt = cfg.options.find(function(o) { return o.field === options.choiceField; });
        result.label = chosenOpt ? chosenOpt.label : '';
      } else {
        result.needsCustomQuote = true;
      }
    }
  } else if (cfg.method === 'pages') {
    // Narracja — cena per strona A4
    var pages = wordsToPages(wordCount);
    for (var j = 0; j < cfg.tiers.length; j++) {
      var pageTier = cfg.tiers[j];
      if (pages <= pageTier.max) {
        var pagePrice = LEKTOR_PRICES[pageTier.field];
        if (pagePrice && pagePrice !== 'wycena') {
          result.basePrice = parseInt(pagePrice);
          result.label = pageTier.label + ' (~' + pages.toFixed(1) + ' str.)';
        } else {
          result.needsCustomQuote = true;
          result.label = pageTier.label;
        }
        break;
      }
    }
  }

  return result;
}

// --- Renderowanie pytan per serviceType ---
function renderQuestions(serviceType, targetEl) {
  var cfg = PRICING_MAP[serviceType];
  if (!cfg) { targetEl.innerHTML = ''; return; }

  var html = '';

  if (cfg.method === 'choice') {
    html += '<div class="mb-4">';
    html += '<label class="block text-white font-semibold mb-3 text-sm">' + getQuestionLabel(serviceType) + '</label>';
    html += '<div class="space-y-2">';
    cfg.options.forEach(function(opt) {
      var price = LEKTOR_PRICES[opt.field];
      var priceLabel = price ? (' — ' + price + ' zł netto') : '';
      html += '<label class="flex items-center gap-3 bg-dark-700 rounded-lg p-3 cursor-pointer hover:bg-dark-600 transition-colors border border-transparent has-[:checked]:border-accent/50">' +
        '<input type="radio" name="service-choice" value="' + opt.field + '" class="accent-emerald-600" onchange="onChoiceChange(this)">' +
        '<span class="text-gray-300 text-sm">' + opt.label + '<span class="text-accent font-semibold">' + priceLabel + '</span></span>' +
      '</label>';
    });
    html += '</div>';
    if (cfg.note) {
      html += '<p class="text-xs text-gray-500 mt-2">' + cfg.note + '</p>';
    }
    html += '</div>';
  }

  targetEl.innerHTML = html;
}

function getQuestionLabel(serviceType) {
  switch(serviceType) {
    case 'radio': return 'Jaki zasieg reklamy radiowej?';
    case 'tv': return 'Jaki zasieg reklamy telewizyjnej?';
    case 'social': return 'Czas trwania nagrania:';
    default: return 'Wybierz opcje:';
  }
}

// --- Renderowanie wyceny ---
function renderPricing(result, wordCount, targetEl) {
  if (!result) { targetEl.innerHTML = ''; targetEl.classList.add('hidden'); return; }

  var html = '<div class="bg-accent/5 border border-accent/20 rounded-xl p-4 mt-4">';

  if (result.needsCustomQuote) {
    html += '<div class="text-center">' +
      '<p class="text-yellow-400 text-sm font-medium">Wycena indywidualna</p>' +
      '<p class="text-gray-400 text-xs mt-1">Skontaktuj sie, aby uzyskac dokladna wycene.</p>' +
    '</div>';
  } else if (result.basePrice) {
    var totalBase = result.basePrice;

    html += '<div class="flex items-center justify-between mb-2">' +
      '<span class="text-gray-400 text-sm">' + result.label + '</span>' +
      '<span class="text-white font-bold">' + result.basePrice + ' zł netto</span>' +
    '</div>';

    // Nagranie dwujezyczne — automatycznie doliczane
    if (result.bilingualPrice) {
      totalBase += result.bilingualPrice;
      html += '<div class="flex items-center justify-between mb-2">' +
        '<span class="text-gray-400 text-sm">Nagranie dwujęzyczne</span>' +
        '<span class="text-white font-bold">+' + result.bilingualPrice + ' zł netto</span>' +
      '</div>';
    }

    // Addony (checkboxy IVR)
    if (result.addons && result.addons.length > 0) {
      html += '<div class="border-t border-white/5 pt-3 mt-2 space-y-2">';
      html += '<p class="text-xs text-gray-500 mb-1">Dodatki:</p>';
      result.addons.forEach(function(addon, idx) {
        html += '<label class="flex items-center justify-between gap-3 cursor-pointer">' +
          '<span class="flex items-center gap-2">' +
            '<input type="checkbox" class="addon-checkbox accent-emerald-600" data-price="' + addon.price + '" onchange="recalcTotal()">' +
            '<span class="text-gray-300 text-sm">' + addon.label + '</span>' +
            (addon.tooltip ? '<span class="addon-tooltip-trigger text-gray-500 hover:text-gray-300 cursor-help" data-tooltip-idx="' + idx + '" onclick="toggleAddonTooltip(event, ' + idx + ')">&#10067;</span>' : '') +
          '</span>' +
          '<span class="text-gray-400 text-sm">+' + addon.price + ' zł netto</span>' +
        '</label>';
        if (addon.tooltip) {
          html += '<div id="addon-tooltip-' + idx + '" class="hidden bg-dark-600 rounded-lg p-3 ml-6 text-xs text-gray-400 border border-white/5">' +
            '<span class="text-gray-500 mr-1">&#9432;</span>' + addon.tooltip +
          '</div>';
        }
      });
      html += '</div>';
    }

    // Suma
    html += '<div class="border-t border-accent/20 mt-3 pt-3 flex items-center justify-between">' +
      '<span class="text-white font-bold">Łącznie:</span>' +
      '<span id="pricing-total" class="text-2xl font-bold text-accent">' + totalBase + ' zł netto</span>' +
    '</div>';

    // Ceny netto
    html += '<p class="text-xs text-gray-500 mt-2">Do podanych cen należy doliczyć VAT 23%</p>';

    if (result.note) {
      html += '<p class="text-xs text-gray-500 mt-1">' + result.note + '</p>';
    }
  }

  html += '</div>';
  targetEl.innerHTML = html;
  targetEl.classList.remove('hidden');

  // Store base price for recalc (including bilingual)
  targetEl.dataset.basePrice = (result.basePrice || 0) + (result.bilingualPrice || 0);
}

function toggleAddonTooltip(e, idx) {
  e.preventDefault();
  e.stopPropagation();
  var tip = document.getElementById('addon-tooltip-' + idx);
  if (tip) tip.classList.toggle('hidden');
}

function recalcTotal() {
  // Szukaj basePrice w widocznym kontenerze wyceny
  var containers = ['wizard-pricing', 'modal-pricing'];
  var total = 0;
  for (var i = 0; i < containers.length; i++) {
    var el = document.getElementById(containers[i]);
    if (el && el.dataset.basePrice) { total = parseInt(el.dataset.basePrice) || 0; break; }
  }
  document.querySelectorAll('.addon-checkbox:checked').forEach(function(cb) {
    total += parseInt(cb.dataset.price) || 0;
  });
  var totalEl = document.getElementById('pricing-total');
  if (totalEl) totalEl.textContent = total + ' zł netto';
}

// --- Modal: Zamow nagranie ---
function showOrderModal() {
  var el = document.getElementById('order-modal');
  if (el) { el.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
}
function closeOrderModal() {
  var el = document.getElementById('order-modal');
  if (el) { el.classList.add('hidden'); document.body.style.overflow = ''; }
}

function onChoiceChange(radio) {
  // Rozpoznaj kontekst: wizard vs modal
  if (radio.closest('#wizard-questions')) {
    wizardChoiceChanged(radio);
  } else {
    modalCalculate();
  }
}

function wizardChoiceChanged(radio) {
  var textPreview = document.getElementById('wizard-text-preview');
  var pricingEl = document.getElementById('wizard-pricing');
  var ctaEl = document.getElementById('wizard-cta');
  if (!textPreview) return;

  var wordCount = countWords(textPreview.textContent);
  var serviceType = null;

  // Pobierz serviceType z kontekstu lub selecta
  try {
    var ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}');
    serviceType = SERVICE_TYPE_MAP[ctx.serviceType] || null;
  } catch(e) {}
  if (!serviceType) {
    var sel = document.getElementById('wizard-service-select');
    if (sel) serviceType = sel.value;
  }
  if (!serviceType) return;

  var result = calculatePrice(serviceType, wordCount, { choiceField: radio.value });
  renderPricing(result, wordCount, pricingEl);
  ctaEl.classList.remove('hidden');
}

function modalCalculate() {
  // Wywolywane z onChoiceChange (radio button w modalu)
  var text = document.getElementById('modal-text-input').value.trim();
  var serviceType = document.getElementById('modal-service-select').value;
  var questionsEl = document.getElementById('modal-questions');
  var pricingEl = document.getElementById('modal-pricing');
  var ctaEl = document.getElementById('modal-order-cta');

  if (!text || !serviceType) return;

  var wordCount = countWords(text);
  var cfg = PRICING_MAP[serviceType];
  if (!cfg) return;

  if (cfg.method === 'choice') {
    var chosen = questionsEl.querySelector('input[name="service-choice"]:checked');
    if (!chosen) return;
    var result = calculatePrice(serviceType, wordCount, { choiceField: chosen.value });
    renderPricing(result, wordCount, pricingEl);
  } else {
    var result = calculatePrice(serviceType, wordCount, {});
    renderPricing(result, wordCount, pricingEl);
  }

  ctaEl.classList.remove('hidden');

  var ctx = { text: text, serviceType: serviceType, lektorName: LEKTOR_NAME, lektorId: LEKTOR_ID, timestamp: Date.now() };
  try { sessionStorage.setItem('kreatorContext', JSON.stringify(ctx)); } catch(e) {}
}

// Auto-kalkulacja w modalu — po wpisaniu tekstu i wyborze typu
(function() {
  var sel = document.getElementById('modal-service-select');
  var textarea = document.getElementById('modal-text-input');
  var debounceTimer = null;

  function autoCalc() {
    var text = textarea ? textarea.value.trim() : '';
    var serviceType = sel ? sel.value : '';
    if (!text || !serviceType) return;

    var questionsEl = document.getElementById('modal-questions');
    var pricingEl = document.getElementById('modal-pricing');
    var ctaEl = document.getElementById('modal-order-cta');
    var wordCount = countWords(text);
    var cfg = PRICING_MAP[serviceType];
    if (!cfg) return;

    if (cfg.method === 'choice') {
      // Renderuj pytania jesli nie ma jeszcze
      if (!questionsEl.innerHTML.trim()) {
        renderQuestions(serviceType, questionsEl);
        pricingEl.classList.add('hidden');
        ctaEl.classList.add('hidden');
        return;
      }
      var chosen = questionsEl.querySelector('input[name="service-choice"]:checked');
      if (!chosen) return;
      var result = calculatePrice(serviceType, wordCount, { choiceField: chosen.value });
      renderPricing(result, wordCount, pricingEl);
    } else {
      var result = calculatePrice(serviceType, wordCount, {});
      renderPricing(result, wordCount, pricingEl);
    }

    ctaEl.classList.remove('hidden');
    var ctx = { text: text, serviceType: serviceType, lektorName: LEKTOR_NAME, lektorId: LEKTOR_ID, timestamp: Date.now() };
    try { sessionStorage.setItem('kreatorContext', JSON.stringify(ctx)); } catch(e) {}
  }

  if (sel) sel.addEventListener('change', function() {
    var questionsEl = document.getElementById('modal-questions');
    var pricingEl = document.getElementById('modal-pricing');
    var ctaEl = document.getElementById('modal-order-cta');
    questionsEl.innerHTML = '';
    pricingEl.innerHTML = '';
    pricingEl.classList.add('hidden');
    ctaEl.classList.add('hidden');
    autoCalc();
  });

  if (textarea) textarea.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(autoCalc, 500);
  });
})();

function submitModalOrder() {
  var firmName = document.getElementById('mod-firmName').value.trim();
  var name = document.getElementById('mod-name').value.trim();
  var email = document.getElementById('mod-email').value.trim();
  if (!firmName || !name || !email) { alert('Uzupelnij wymagane pola: nazwa firmy, imie i nazwisko, email.'); return; }

  var data = {
    firmName: firmName,
    name: name,
    nip: document.getElementById('mod-nip').value.trim(),
    street: document.getElementById('mod-street').value.trim(),
    zipCode: document.getElementById('mod-zipCode').value.trim(),
    city: document.getElementById('mod-city').value.trim(),
    email: email,
    phone: document.getElementById('mod-phone').value.trim(),
    notes: document.getElementById('mod-notes').value.trim(),
    lektorName: LEKTOR_NAME,
    lektorId: LEKTOR_ID,
    serviceType: document.getElementById('modal-service-select').value,
    generatedText: document.getElementById('modal-text-input').value.trim()
  };
  // Dodaj cene
  var pricingEl = document.getElementById('modal-pricing');
  if (pricingEl && pricingEl.dataset.basePrice) data.totalPrice = pricingEl.dataset.basePrice;
  var totalEl = document.getElementById('pricing-total');
  if (totalEl) data.totalPrice = totalEl.textContent;

  submitOrderRequest(data, 'modal-order-msg');
}

function submitWizardOrder() {
  var firmName = document.getElementById('wiz-firmName').value.trim();
  var name = document.getElementById('wiz-name').value.trim();
  var email = document.getElementById('wiz-email').value.trim();
  if (!firmName || !name || !email) { alert('Uzupelnij wymagane pola: nazwa firmy, imie i nazwisko, email.'); return; }

  var ctx = {};
  try { ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}'); } catch(e) {}

  var data = {
    firmName: firmName,
    name: name,
    nip: document.getElementById('wiz-nip').value.trim(),
    street: document.getElementById('wiz-street').value.trim(),
    zipCode: document.getElementById('wiz-zipCode').value.trim(),
    city: document.getElementById('wiz-city').value.trim(),
    email: email,
    phone: document.getElementById('wiz-phone').value.trim(),
    notes: document.getElementById('wiz-notes').value.trim(),
    lektorName: LEKTOR_NAME,
    lektorId: LEKTOR_ID,
    serviceType: ctx.serviceType || '',
    generatedText: ctx.text || ''
  };
  var pricingEl = document.getElementById('wizard-pricing');
  if (pricingEl && pricingEl.dataset.basePrice) data.totalPrice = pricingEl.dataset.basePrice;
  var totalEl = document.getElementById('pricing-total');
  if (totalEl) data.totalPrice = totalEl.textContent;

  submitOrderRequest(data, 'wizard-order-msg');
}

function submitOrderRequest(data, msgElId) {
  var msgEl = document.getElementById(msgElId);
  if (msgEl) { msgEl.classList.add('hidden'); }

  fetch('/api/contact/order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(function(r) { return r.json(); })
  .then(function(res) {
    if (msgEl) {
      msgEl.classList.remove('hidden');
      if (res.ok) {
        msgEl.className = 'text-center text-sm mt-2 text-emerald-500';
        msgEl.textContent = res.message || 'Zamowienie wyslane. Odpowiemy w ciagu 2 godzin.';
        try { sessionStorage.removeItem('kreatorContext'); } catch(e) {}
      } else {
        msgEl.className = 'text-center text-sm mt-2 text-red-400';
        msgEl.textContent = res.error || 'Blad wysylania.';
      }
    }
  })
  .catch(function() {
    if (msgEl) {
      msgEl.className = 'text-center text-sm mt-2 text-red-400';
      msgEl.textContent = 'Blad polaczenia. Sprobuj ponownie.';
      msgEl.classList.remove('hidden');
    }
  });
}

function goToKreatorWithLektor() {
  var ctx = { lektorName: LEKTOR_NAME, lektorId: LEKTOR_ID, returnUrl: window.location.pathname, timestamp: Date.now() };
  try { sessionStorage.setItem('kreatorContext', JSON.stringify(ctx)); } catch(e) {}
  closeOrderModal();
  window.location.href = '/#kreator';
}

// --- Modal: Zapytaj o wycene ---
function showInquiryModal() {
  var el = document.getElementById('inquiry-modal');
  if (el) { el.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
}
function closeInquiryModal() {
  var el = document.getElementById('inquiry-modal');
  if (el) { el.classList.add('hidden'); document.body.style.overflow = ''; }
  var msg = document.getElementById('inquiry-modal-msg');
  if (msg) { msg.classList.add('hidden'); }
}

var inquiryModalForm = document.getElementById('inquiry-modal-form');
if (inquiryModalForm) inquiryModalForm.addEventListener('submit', function(e) {
  e.preventDefault();
  var fd = new FormData(e.target);
  var data = {};
  fd.forEach(function(v, k) { data[k] = v; });
  data.lektorName = LEKTOR_NAME;
  data.lektorId = LEKTOR_ID;
  try {
    var ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}');
    if (ctx.text) data.generatedText = ctx.text;
  } catch(ex) {}

  var submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Wysylanie...';

  fetch('/api/contact/inquiry', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(function(r) { return r.json(); })
  .then(function(res) {
    var msg = document.getElementById('inquiry-modal-msg');
    msg.classList.remove('hidden');
    if (res.ok) {
      msg.className = 'mt-4 text-center text-sm text-emerald-500';
      msg.textContent = res.message || 'Dziekujemy! Odpowiemy w ciagu 2 godzin.';
      e.target.reset();
      setTimeout(closeInquiryModal, 2500);
    } else {
      msg.className = 'mt-4 text-center text-sm text-red-400';
      msg.textContent = res.error || 'Blad wysylania.';
    }
  })
  .catch(function() {
    var msg = document.getElementById('inquiry-modal-msg');
    msg.className = 'mt-4 text-center text-sm text-red-400';
    msg.textContent = 'Blad polaczenia.';
    msg.classList.remove('hidden');
  })
  .finally(function() {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Wyslij zapytanie';
  });
});

// --- Wizard cenowy (kontekst z kreatora) ---
function showPricingWizard(ctx) {
  var wizard = document.getElementById('pricing-wizard');
  var textPreview = document.getElementById('wizard-text-preview');
  var wordCountEl = document.getElementById('wizard-word-count');
  var serviceTypeEl = document.getElementById('wizard-service-type');
  var serviceSelect = document.getElementById('wizard-service-select');
  var questionsEl = document.getElementById('wizard-questions');
  var pricingEl = document.getElementById('wizard-pricing');
  var ctaEl = document.getElementById('wizard-cta');

  if (!wizard || !ctx.text) return;

  // Ukryj CTA sekcje — wizard ma wlasne przyciski
  var ctaSection = document.getElementById('lektor-cta-section');
  if (ctaSection) ctaSection.classList.add('hidden');

  // Ukryj cennik — w flow kreatora konczymy na formularzu zamowienia
  var cennikSection = document.getElementById('lektor-cennik-section');
  if (cennikSection) cennikSection.classList.add('hidden');

  textPreview.textContent = ctx.text;
  var wordCount = countWords(ctx.text);
  wordCountEl.textContent = wordCount + ' slow';

  // Mapuj serviceType z kreatora
  var mappedType = SERVICE_TYPE_MAP[ctx.serviceType] || null;

  if (mappedType) {
    // Typ znany z kreatora — nie pokazuj selecta
    serviceTypeEl.classList.add('hidden');
    var cfg = PRICING_MAP[mappedType];

    if (cfg.method === 'choice') {
      // Dopytaj o parametry
      renderQuestions(mappedType, questionsEl);
      pricingEl.classList.add('hidden');
      ctaEl.classList.add('hidden');

      // Listener na wybor
      questionsEl.addEventListener('change', function(e) {
        if (e.target.name === 'service-choice') {
          var result = calculatePrice(mappedType, wordCount, { choiceField: e.target.value });
          renderPricing(result, wordCount, pricingEl);
          ctaEl.classList.remove('hidden');
        }
      });
    } else {
      // IVR/pages — oblicz od razu
      questionsEl.innerHTML = '';
      var isBilingual = ctx.languages && ctx.languages.length >= 2;
      var result = calculatePrice(mappedType, wordCount, { bilingual: isBilingual });
      renderPricing(result, wordCount, pricingEl);
      ctaEl.classList.remove('hidden');
    }
  } else {
    // Typ nieznany — pokaz select
    serviceTypeEl.classList.remove('hidden');
    questionsEl.innerHTML = '';
    pricingEl.classList.add('hidden');
    ctaEl.classList.add('hidden');
  }

  wizard.classList.remove('hidden');
  wizard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Wizard select change
(function() {
  var sel = document.getElementById('wizard-service-select');
  if (!sel) return;
  sel.addEventListener('change', function() {
    updateWizardPricing();
  });
})();

function updateWizardPricing() {
  var sel = document.getElementById('wizard-service-select');
  var questionsEl = document.getElementById('wizard-questions');
  var pricingEl = document.getElementById('wizard-pricing');
  var ctaEl = document.getElementById('wizard-cta');
  if (!sel) return;

  var serviceType = sel.value;
  questionsEl.innerHTML = '';
  pricingEl.innerHTML = '';
  pricingEl.classList.add('hidden');
  ctaEl.classList.add('hidden');

  if (!serviceType) return;

  var textPreview = document.getElementById('wizard-text-preview');
  var wordCount = countWords(textPreview.textContent);
  var cfg = PRICING_MAP[serviceType];
  if (!cfg) return;

  if (cfg.method === 'choice') {
    renderQuestions(serviceType, questionsEl);
    questionsEl.addEventListener('change', function handler(e) {
      if (e.target.name === 'service-choice') {
        var result = calculatePrice(serviceType, wordCount, { choiceField: e.target.value });
        renderPricing(result, wordCount, pricingEl);
        ctaEl.classList.remove('hidden');
      }
    });
  } else {
    var result = calculatePrice(serviceType, wordCount, {});
    renderPricing(result, wordCount, pricingEl);
    ctaEl.classList.remove('hidden');
  }
}

function orderWithContext() {
  try {
    var ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}');
    ctx.lektorName = LEKTOR_NAME;
    ctx.lektorId = LEKTOR_ID;
    sessionStorage.setItem('kreatorContext', JSON.stringify(ctx));
  } catch(e) {}
  window.location.href = '/?action=order&lektor=' + LEKTOR_ID + '#kreator';
}

function inquiryWithContext() {
  try {
    var ctx = JSON.parse(sessionStorage.getItem('kreatorContext') || '{}');
    ctx.lektorName = LEKTOR_NAME;
    ctx.lektorId = LEKTOR_ID;
    sessionStorage.setItem('kreatorContext', JSON.stringify(ctx));
  } catch(e) {}
  window.location.href = '/?action=inquiry&lektor=' + LEKTOR_ID + '#kreator';
}

function clearPricingContext() {
  try { sessionStorage.removeItem('kreatorContext'); } catch(e) {}
  var wizard = document.getElementById('pricing-wizard');
  if (wizard) wizard.classList.add('hidden');
  // Przywroc CTA sekcje i cennik
  var ctaSection = document.getElementById('lektor-cta-section');
  if (ctaSection) ctaSection.classList.remove('hidden');
  var cennikSection = document.getElementById('lektor-cennik-section');
  if (cennikSection) cennikSection.classList.remove('hidden');
}

// --- Auto-detect context on page load ---
(function() {
  try {
    var ctxStr = sessionStorage.getItem('kreatorContext');
    if (!ctxStr) return;
    var ctx = JSON.parse(ctxStr);
    if (ctx.text && !LEKTOR_HIDE_PRICE) {
      showPricingWizard(ctx);
    }
  } catch(e) {}
})();
</script>

<%- include('partials/foot') %>

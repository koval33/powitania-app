<%- include('partials/head') %>

<!-- HERO -->
<section class="py-12 md:py-16 border-b border-white/5">
  <div class="max-w-6xl mx-auto px-4 text-center">
    <h1 class="text-3xl md:text-4xl font-bold text-white mb-3" style="font-family: 'Poppins', sans-serif;">Bank głosów</h1>
    <p class="text-lg text-gray-400 max-w-2xl mx-auto">Ponad 230 profesjonalnych lektorów w 30+ językach. Odsłuchaj próbki i znajdź idealny głos.</p>
  </div>
</section>

<!-- FILTRY -->
<section class="py-6 bg-dark-800 sticky top-[73px] z-40 border-b border-white/5">
  <div class="max-w-6xl mx-auto px-4">
    <div class="flex flex-wrap items-center gap-3">
      <!-- Płeć -->
      <div class="flex rounded-lg overflow-hidden border border-white/10">
        <button data-filter="gender" data-value="all" class="filter-btn active px-4 py-2 text-sm font-medium">Wszyscy</button>
        <button data-filter="gender" data-value="m" class="filter-btn px-4 py-2 text-sm font-medium">Mężczyźni</button>
        <button data-filter="gender" data-value="f" class="filter-btn px-4 py-2 text-sm font-medium">Kobiety</button>
      </div>

      <!-- Język -->
      <select id="filter-lang" class="bg-dark-700 border border-white/10 text-gray-300 text-sm rounded-lg px-4 py-2 focus:border-accent focus:outline-none">
        <option value="all">Wszystkie języki</option>
        <option value="polski">Polski</option>
        <option value="angielski">Angielski</option>
        <option value="niemiecki">Niemiecki</option>
        <option value="rosyjski">Rosyjski</option>
        <option value="hiszpański">Hiszpański</option>
        <option value="francuski">Francuski</option>
        <option value="ukraiński">Ukraiński</option>
        <option value="portugalski">Portugalski</option>
        <option value="hebrajski">Hebrajski</option>
        <option value="włoski">Włoski</option>
        <option value="czeski">Czeski</option>
        <option value="słowacki">Słowacki</option>
        <option value="węgierski">Węgierski</option>
        <option value="holenderski">Holenderski</option>
        <option value="rumuński">Rumuński</option>
        <option value="turecki">Turecki</option>
        <option value="chiński">Chiński</option>
        <option value="japoński">Japoński</option>
        <option value="koreański">Koreański</option>
        <option value="arabski">Arabski</option>
        <option value="hindi">Hindi</option>
        <option value="szwedzki">Szwedzki</option>
        <option value="norweski">Norweski</option>
        <option value="duński">Duński</option>
        <option value="fiński">Fiński</option>
        <option value="grecki">Grecki</option>
        <option value="chorwacki">Chorwacki</option>
        <option value="serbski">Serbski</option>
        <option value="bułgarski">Bułgarski</option>
        <option value="litewski">Litewski</option>
        <option value="łotewski">Łotewski</option>
      </select>

      <!-- Wiek -->
      <select id="filter-age" class="bg-dark-700 border border-white/10 text-gray-300 text-sm rounded-lg px-4 py-2 focus:border-accent focus:outline-none">
        <option value="all">Każdy wiek</option>
        <option value="20-30">20-30 lat</option>
        <option value="30-50">30-50 lat</option>
        <option value="50+">50+ lat</option>
      </select>

      <!-- Grupa cenowa -->
      <select id="filter-price" class="bg-dark-700 border border-white/10 text-gray-300 text-sm rounded-lg px-4 py-2 focus:border-accent focus:outline-none">
        <option value="all">Grupa cenowa</option>
        <option value="Niższa grupa cenowa">Niższa grupa cenowa</option>
        <option value="Wyższa grupa cenowa">Wyższa grupa cenowa</option>
      </select>

      <!-- Specjalne -->
      <label class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer hover:text-white transition-colors">
        <input type="checkbox" id="filter-famous" class="w-4 h-4 rounded bg-dark-700 border-white/10 text-accent focus:ring-accent">
        Znani i lubiani
      </label>
      <label class="flex items-center gap-2 text-sm text-gray-400 cursor-pointer hover:text-white transition-colors">
        <input type="checkbox" id="filter-native" class="w-4 h-4 rounded bg-dark-700 border-white/10 text-accent focus:ring-accent">
        Tylko natives
      </label>

      <!-- Szukaj -->
      <div class="ml-auto">
        <input type="text" id="filter-search" placeholder="Szukaj lektora..." class="bg-dark-700 border border-white/10 text-gray-300 text-sm rounded-lg px-4 py-2 w-48 focus:border-accent focus:outline-none placeholder-gray-500">
      </div>
    </div>
  </div>
</section>

<!-- KREATOR CONTEXT BANNER -->
<div id="kreator-context-banner" class="max-w-6xl mx-auto px-4 pt-4 hidden">
  <div class="bg-accent/10 border-2 border-accent/40 rounded-xl p-5 flex items-start gap-4">
    <svg class="w-6 h-6 text-accent flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    <div class="flex-1">
      <h3 class="text-white font-bold mb-1">Twój tekst jest gotowy</h3>
      <p class="text-sm text-gray-300 mb-3">Wybierz lektora poniżej, aby zobaczyć wycenę dla tego tekstu</p>
      <div class="bg-dark-800 rounded-lg p-3">
        <div class="text-xs text-gray-500 mb-1">Podgląd tekstu:</div>
        <div id="context-text-preview" class="text-sm text-gray-300 line-clamp-3"></div>
      </div>
    </div>
    <button onclick="clearKreatorContext()" class="text-gray-400 hover:text-white transition-colors flex-shrink-0" title="Zamknij">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
  </div>
</div>

<!-- LICZNIK -->
<div class="max-w-6xl mx-auto px-4 py-4">
  <p class="text-sm text-gray-500">Znaleziono: <span id="voice-count" class="text-white font-semibold"><%= voices.length %></span> lektorów</p>
</div>

<!-- SIATKA LEKTORÓW -->
<section class="pb-16">
  <div class="max-w-6xl mx-auto px-4">
    <div id="voices-grid" class="grid md:grid-cols-2 gap-6">
      <% voices.forEach(function(v, idx) { %>
      <div class="voice-card bg-dark-800 rounded-xl border border-white/5 overflow-hidden hover:border-accent/30 transition-all<%= idx >= 20 ? ' hidden' : '' %>"
           data-gender="<%= v.gender %>"
           data-age="<%= v.age %>"
           data-languages="<%= v.languages.join(',') %>"
           data-famous="<%= v.famous %>"
           data-native="<%= v.native %>"
           data-price="<%= v.priceGroup || '' %>"
           data-name="<%= v.name.toLowerCase() %>">

        <!-- Górna część: zdjęcie + info -->
        <div class="flex items-start gap-5 p-6 pb-3">
          <!-- Zdjęcie (klikalne → profil) -->
          <a href="<%= v.profileUrl %>" class="flex-shrink-0 w-28 h-28 rounded-xl overflow-hidden bg-dark-700 block hover:ring-2 hover:ring-accent/40 transition-all">
            <% if (v.photo) { %>
              <img src="<%= v.photo %>" alt="<%= v.name %>" class="w-full h-full object-cover" loading="lazy">
            <% } else { %>
              <div class="w-full h-full flex items-center justify-center text-gray-600">
                <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              </div>
            <% } %>
          </a>

          <!-- Info -->
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-2">
              <h3 class="text-xl font-bold text-white leading-tight"><%= v.name %></h3>
              <% if (v.famous) { %>
                <span class="flex-shrink-0 text-xs bg-yellow-500/10 text-yellow-400 px-2.5 py-1 rounded font-medium whitespace-nowrap">Znany glos</span>
              <% } else if (v.native) { %>
                <span class="flex-shrink-0 text-xs bg-blue-500/10 text-blue-400 px-2.5 py-1 rounded font-medium whitespace-nowrap">Native</span>
              <% } %>
            </div>
            <div class="flex items-center gap-2 mt-1.5 flex-wrap">
              <% if (v.age) { %>
                <span class="text-sm text-gray-500"><%= v.age %></span>
                <span class="text-sm text-gray-600">&bull;</span>
              <% } %>
              <% v.languages.forEach(function(lang) { %>
                <span class="text-xs bg-dark-600 text-gray-300 px-2 py-0.5 rounded"><%= lang %></span>
              <% }); %>
            </div>
            <% if (v.description) { %>
              <p class="text-sm text-gray-400 mt-2 line-clamp-3"><%= v.description %></p>
            <% } %>
            <% if (v.turnaround) { %>
              <p class="text-xs text-gray-500 mt-2">Realizacja: <%= v.turnaround %></p>
            <% } %>
          </div>
        </div>

        <!-- Audio player -->
        <div class="px-6 pb-4">
          <div class="flex items-center gap-3 bg-dark-900/50 rounded-lg p-3">
            <button class="play-btn w-11 h-11 flex-shrink-0 bg-accent hover:bg-accent-light rounded-full flex items-center justify-center transition-colors" data-audio="<%= v.audio %>">
              <svg class="play-icon w-5 h-5 text-white ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
              <svg class="pause-icon w-5 h-5 text-white hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <div class="flex-1">
              <div class="audio-progress w-full h-2 bg-dark-600 rounded-full overflow-hidden cursor-pointer">
                <div class="audio-bar h-full bg-accent rounded-full transition-all" style="width: 0%"></div>
              </div>
              <div class="flex justify-between mt-1">
                <span class="audio-time text-xs text-gray-500">0:00</span>
                <span class="audio-duration text-xs text-gray-500">--:--</span>
              </div>
            </div>
            <a href="<%= v.audio %>" download title="Pobierz próbkę MP3" class="w-9 h-9 flex-shrink-0 flex items-center justify-center rounded-full text-gray-500 hover:text-white hover:bg-dark-600 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
            </a>
          </div>
        </div>

        <!-- Footer -->
        <div class="flex items-center justify-between px-6 pb-5">
          <% if (!v.hidePrice && v.prices && v.prices.ivr_100) { %>
            <span class="text-xs text-gray-500">od <%= v.prices.ivr_100 %> zł</span>
          <% } else if (v.hidePrice) { %>
            <span class="text-xs text-yellow-400">wycena indyw.</span>
          <% } else { %>
            <span></span>
          <% } %>
          <a href="<%= v.profileUrl %>" class="text-accent hover:text-accent-light text-sm font-medium transition-colors">
            Więcej &rarr;
          </a>
        </div>
      </div>
      <% }); %>
    </div>

    <!-- Załaduj więcej -->
    <div id="load-more-wrap" class="text-center mt-10">
      <button id="load-more-btn" class="bg-dark-700 hover:bg-dark-600 border border-white/10 text-white px-8 py-3 rounded-lg font-medium transition-colors">
        Załaduj więcej lektorów
      </button>
      <p id="load-more-info" class="text-sm text-gray-500 mt-3">Pokazano <span id="shown-count">20</span> z <span id="total-filtered">0</span></p>
    </div>

    <!-- Pusty stan -->
    <div id="no-results" class="hidden text-center py-16">
      <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
      <p class="text-gray-500 text-lg">Nie znaleziono lektorów spełniających kryteria</p>
      <button onclick="resetFilters()" class="mt-4 text-accent hover:text-accent-light text-sm font-medium">Wyczysc filtry</button>
    </div>
  </div>
</section>

<!-- CTA -->
<section class="py-12 bg-dark-800 border-t border-white/5">
  <div class="max-w-3xl mx-auto px-4 text-center">
    <h2 class="text-2xl font-bold text-white mb-3">Nie możesz się zdecydować?</h2>
    <p class="text-gray-400 mb-6">Opisz swój projekt, a pomożemy dobrać idealny głos.</p>
    <a href="/kontakt/" class="inline-block bg-accent hover:bg-accent-light text-white px-8 py-3 rounded-lg font-semibold transition-colors">Zapytaj o lektora</a>
    <p class="text-gray-500 text-sm mt-3">lub <a href="/#kreator" class="text-accent hover:text-accent-light font-medium">stwórz tekst w kreatorze</a></p>
  </div>
</section>

<script>
(function() {
  var PAGE_SIZE = 20;
  var currentAudio = null;
  var currentBtn = null;
  var allCards = Array.from(document.querySelectorAll('.voice-card'));
  var filteredCards = allCards.slice();
  var shownCount = PAGE_SIZE;

  // --- Audio player ---
  function initAudioPlayer(btn) {
    btn.addEventListener('click', function() {
      var src = this.dataset.audio;
      var card = this.closest('.voice-card');
      var playIcon = this.querySelector('.play-icon');
      var pauseIcon = this.querySelector('.pause-icon');
      var bar = card.querySelector('.audio-bar');
      var timeEl = card.querySelector('.audio-time');
      var durEl = card.querySelector('.audio-duration');

      if (currentAudio && currentBtn !== this) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentBtn.querySelector('.play-icon').classList.remove('hidden');
        currentBtn.querySelector('.pause-icon').classList.add('hidden');
        currentBtn.closest('.voice-card').querySelector('.audio-bar').style.width = '0%';
      }

      if (currentAudio && currentBtn === this && !currentAudio.paused) {
        currentAudio.pause();
        playIcon.classList.remove('hidden');
        pauseIcon.classList.add('hidden');
        return;
      }

      if (!currentAudio || currentBtn !== this) {
        currentAudio = new Audio(src);
        currentBtn = this;

        currentAudio.addEventListener('loadedmetadata', function() {
          durEl.textContent = formatTime(currentAudio.duration);
        });
        currentAudio.addEventListener('timeupdate', function() {
          var pct = (currentAudio.currentTime / currentAudio.duration) * 100;
          bar.style.width = pct + '%';
          timeEl.textContent = formatTime(currentAudio.currentTime);
        });
        currentAudio.addEventListener('ended', function() {
          playIcon.classList.remove('hidden');
          pauseIcon.classList.add('hidden');
          bar.style.width = '0%';
          timeEl.textContent = '0:00';
        });

        card.querySelector('.audio-progress').addEventListener('click', function(e) {
          if (currentAudio && currentBtn === btn) {
            var rect = this.getBoundingClientRect();
            var pct = (e.clientX - rect.left) / rect.width;
            currentAudio.currentTime = pct * currentAudio.duration;
          }
        });
      }

      currentAudio.play();
      playIcon.classList.add('hidden');
      pauseIcon.classList.remove('hidden');
    });
  }

  allCards.forEach(function(card) {
    initAudioPlayer(card.querySelector('.play-btn'));
  });

  function formatTime(s) {
    var m = Math.floor(s / 60);
    var sec = Math.floor(s % 60);
    return m + ':' + (sec < 10 ? '0' : '') + sec;
  }

  // --- Pagination ---
  function updateVisibility() {
    var visibleCount = 0;
    filteredCards.forEach(function(card, i) {
      if (i < shownCount) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    // Hide cards not in filtered set
    allCards.forEach(function(card) {
      if (filteredCards.indexOf(card) === -1) {
        card.classList.add('hidden');
      }
    });

    var totalFiltered = filteredCards.length;
    document.getElementById('voice-count').textContent = totalFiltered;
    document.getElementById('shown-count').textContent = Math.min(shownCount, totalFiltered);
    document.getElementById('total-filtered').textContent = totalFiltered;

    var loadMoreWrap = document.getElementById('load-more-wrap');
    var noResults = document.getElementById('no-results');

    if (totalFiltered === 0) {
      loadMoreWrap.classList.add('hidden');
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
      if (shownCount >= totalFiltered) {
        loadMoreWrap.classList.add('hidden');
      } else {
        loadMoreWrap.classList.remove('hidden');
      }
    }
  }

  document.getElementById('load-more-btn').addEventListener('click', function() {
    shownCount += PAGE_SIZE;
    updateVisibility();
  });

  // --- Filters ---
  var activeGender = 'all';

  document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      this.parentElement.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
      this.classList.add('active');
      activeGender = this.dataset.value;
      applyFilters();
    });
  });

  document.getElementById('filter-lang').addEventListener('change', applyFilters);
  document.getElementById('filter-age').addEventListener('change', applyFilters);
  document.getElementById('filter-price').addEventListener('change', applyFilters);
  document.getElementById('filter-famous').addEventListener('change', applyFilters);
  document.getElementById('filter-native').addEventListener('change', applyFilters);
  document.getElementById('filter-search').addEventListener('input', applyFilters);

  function applyFilters() {
    var lang = document.getElementById('filter-lang').value;
    var age = document.getElementById('filter-age').value;
    var price = document.getElementById('filter-price').value;
    var famous = document.getElementById('filter-famous').checked;
    var native_ = document.getElementById('filter-native').checked;
    var search = document.getElementById('filter-search').value.toLowerCase();

    filteredCards = allCards.filter(function(card) {
      if (activeGender !== 'all' && card.dataset.gender !== activeGender) return false;
      if (lang !== 'all' && card.dataset.languages.indexOf(lang) === -1) return false;
      if (age !== 'all') {
        var cardAge = card.dataset.age;
        if (age === '50+') {
          if (cardAge !== '50 lat +' && cardAge !== '50+') return false;
        } else if (age === '20-30') {
          if (cardAge !== '20-30 lat' && cardAge !== '20-30') return false;
        } else if (age === '30-50') {
          if (cardAge !== '30-50 lat' && cardAge !== '30-50') return false;
        }
      }
      if (price !== 'all' && card.dataset.price !== price) return false;
      if (famous && card.dataset.famous !== 'true') return false;
      if (native_ && card.dataset.native !== 'true') return false;
      if (search && card.dataset.name.indexOf(search) === -1) return false;
      return true;
    });

    shownCount = PAGE_SIZE;
    updateVisibility();
  }

  window.resetFilters = function() {
    activeGender = 'all';
    document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
    document.querySelector('.filter-btn[data-value="all"]').classList.add('active');
    document.getElementById('filter-lang').value = 'all';
    document.getElementById('filter-age').value = 'all';
    document.getElementById('filter-price').value = 'all';
    document.getElementById('filter-famous').checked = false;
    document.getElementById('filter-native').checked = false;
    document.getElementById('filter-search').value = '';
    applyFilters();
  };

  // Init
  updateVisibility();
})();

// Kreator context detection
(function() {
  try {
    var ctxStr = sessionStorage.getItem('kreatorContext');
    if (!ctxStr) return;
    var ctx = JSON.parse(ctxStr);
    if (!ctx.text) return;
    var banner = document.getElementById('kreator-context-banner');
    var preview = document.getElementById('context-text-preview');
    if (banner && preview) {
      preview.textContent = ctx.text;
      banner.classList.remove('hidden');
    }
  } catch(e) {}
})();

function clearKreatorContext() {
  try { sessionStorage.removeItem('kreatorContext'); } catch(e) {}
  var banner = document.getElementById('kreator-context-banner');
  if (banner) banner.classList.add('hidden');
}
</script>

<style>
.filter-btn { color: #9ca3af; background: transparent; transition: all 0.2s; }
.filter-btn:hover { color: #fff; }
.filter-btn.active { color: #fff; background: #e8530e; }
.line-clamp-3 {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>

<%- include('partials/foot') %>
